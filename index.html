<!DOCTYPE html> 
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Atlas Planetarny</title>
<script src="https://unpkg.com/three"></script>
<script src="https://unpkg.com/globe.gl"></script>
<script src="icons.js"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="form">
    <div id="tabs">
      <button class="lock-while-edit active" onclick="openTab('start')">Start</button>
      <button class="lock-while-edit" onclick="openTab('planety')">Planety</button>
      <button class="lock-while-edit" onclick="openTab('punkty')">Punkty</button>
      <button class="lock-while-edit" onclick="openTab('detale')">Detale planety</button>
    </div>

    <!-- ZakÅ‚adka START -->
    <div id="start" class="tab-content active">
      <div id="noPlanetsMessage" style="color: #ffcc00; font-weight: bold; text-align: center; margin: 0.5rem 0;">
        StwÃ³rz nowÄ… planetÄ™ lub importuj dane JSON
      </div>
      <h2>Dodaj punkt</h2>
      <div class="xy-inputs">
        <div>
          <label>X (âˆ’90 do 90)</label>
          <input type="number" id="lat" step="1" min="-90" max="90" />
        </div>
        <div>
          <label>Y (âˆ’180 do 180)</label>
          <input type="number" id="lng" step="1" min="-180" max="180" />
        </div>
      </div>
      <label>Nazwa punktu</label>
      <input type="text" id="name" onkeydown="if(event.key === 'Enter') addPoint()" />
      <label>Typ</label>
      <select id="type">
        <option>ZasÃ³b</option>
        <option>Baza</option>
        <option>Ruiny</option>
        <option>Struktura</option>
        <option>Inne</option>
      </select>
      <label>Notatki</label>
      <textarea id="notes"></textarea>
      <button onclick="addPoint()">Dodaj punkt</button>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <h2>Skalowanie globu i punktÃ³w</h2>
      <!-- Suwak 1: Skalowanie punktÃ³w -->
      <label>Skalowanie punktÃ³w</label>
      <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
        <input type="range" id="pointScale" min="0.1" max="1" step="0.1" value="0.4" oninput="updatePointScale()" style="flex:1;" />
        <span id="pointScaleValue" style="width:2rem; text-align:center;">0.4</span>
        <button onclick="resetPointScale()" style="padding:0.2rem 0.3rem; font-size:12px; width:auto;">Reset</button>
      </div>
      <!-- Suwak 2: WysokoÅ›Ä‡ sÅ‚upka -->
      <label>WysokoÅ›Ä‡ sÅ‚upka</label>
      <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
        <input type="range" id="pointsDistanceMultiplier" min="0.5" max="30" step="0.5" value="1" oninput="updatePointsDistanceMultiplier()" style="flex:1;" />
        <span id="pointsDistanceMultiplierValue" style="width:2rem; text-align:center;">1</span>
        <button onclick="resetPointsDistanceMultiplier()" style="padding:0.2rem 0.3rem; font-size:12px; width:auto;">Reset</button>
      </div>
      <!-- Suwak 3: Zoom globu -->
      <label>Zoom globu</label>
      <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
        <input type="range" id="globeZoomMultiplier" min="0.5" max="2" step="0.05" value="1" oninput="updateGlobeZoomMultiplier()" style="flex:1;" />
        <span id="globeZoomMultiplierValue" style="width:2rem; text-align:center;">1</span>
        <button onclick="resetGlobeZoomMultiplier()" style="padding:0.2rem 0.3rem; font-size:12px; width:auto;">Reset</button>
      </div>
      <!-- AutoobrÃ³t -->
	     		<table style="width: 100%; margin-top: 0.5rem; border-collapse: collapse;">
		  <tr>
		    <td style="width: 70%; text-align: left;">
		      Obracanie globu
		    </td>
		    <td style="width: 30%; text-align: left;">
		      <input type="checkbox" id="autoRotateCheckbox" onchange="toggleAutoRotate()" />
		    </td>
		  </tr>
		</table>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <h2>Import/Eksport</h2>
      <button class="lock-while-edit" onclick="exportAtlas()">Eksport JSON</button>
      <input class="lock-while-edit" type="file" id="importFile" accept="application/json" onchange="importAtlas(event)" />
    </div>
	
    <!-- ZakÅ‚adka PLANETY -->
<div id="planety" class="tab-content">

  <!-- Sub-zakÅ‚adka Szukaj -->
  <div id="planetSearchTab" style="display:none; border:1px solid #102b56; padding:0.5rem; border-radius:6px; margin-bottom:1rem;">
    <input type="text" id="planetSearchInput" placeholder="Wpisz nazwÄ™ planety..." />
    <button onclick="searchPlanet()">Szukaj</button>
    <div id="planetSearchResults" style="margin-top:0.5rem;"></div>
    <button onclick="backToPlanets()" style="margin-top:0.5rem;">â¬… PowrÃ³t</button>
	<div id="planetList"></div>
  </div>

  <!-- GÅ‚Ã³wna czÄ™Å›Ä‡ zakÅ‚adki Planety -->
  <div id="planetMainTab" style="display:block;">
    <div style="display:flex; flex-direction:column; gap:0.5rem; margin-bottom:1rem;">

      <!-- Przyciski w zakÅ‚adce Planety -->
      <div style="display:flex; gap:0.5rem; margin-bottom:0.5rem;">
        <button onclick="showPlanetSearchTab()">Szukaj</button>
      </div>

      <!-- nazwa planety -->
      <input type="text" id="newPlanetName" class="lock-while-edit" placeholder="Nazwa nowej planety" oninput="checkNewPlanetInput()" onkeydown="if(event.key === 'Enter') addNewPlanet()" />

<!-- guzik tworzenia planety -->
      <button id="addPlanetBtn" class="lock-while-edit" onclick="addNewPlanet()">StwÃ³rz nowÄ… planetÄ™</button>
	  
	  <table style="width: 100%; border-collapse: collapse; margin-top: 0; margin-bottom: 0;">
		  <tr style="margin:0; padding:0;">
			<td style="width: 70%; text-align: left; padding: 0; margin: 0; line-height: 1;">
			  TwÃ³rz jako ksiÄ™Å¼yc
			</td>
			<td style="width: 30%; text-align: left; padding: 0; margin: 0;">
			  <input type="checkbox" id="isMoonCheckbox" style="margin:0;" />
			</td>
		  </tr>
		</table>
	  
      <button id="generatePlanetNameBtn" onclick="generatePlanetName()" style="flex:1;"> Generuj nazwÄ™ </button>
	  	  
    </div>

      <!-- label + piker -->
      <div style="text-align:center">
        <label>Wybierz kolor</label>
        <input type="color" id="PlanetColor" value="#000000" class="lock-while-edit" style="width:100%; height:40px;">
      </div>
      
    <!-- Przycisk dodaj texturÄ™ i zmieÅ„ kolor -->
    <div style="display:flex; flex-direction:column; gap:0.5rem; margin-bottom:1rem;">
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <input type="text" id="planetTextureUrl" class="lock-while-edit" placeholder="URL tekstury" oninput="checkTextureInput()" />
      <div class="planet-buttons-row">
        <button id="setTextureBtn" class="lock-while-edit" onclick="addTextureUrl()">Ustaw teksturÄ™</button>
        <button id="setColorBtn" class="lock-while-edit" onclick="changePlanetColor()">ZmieÅ„ kolor</button>
      </div>
    </div>

    <!-- Galeria miniatur -->
    <div id="textureGalleryContainer" class="lock-while-edit">
      <div id="textureGallery"></div>
      <div id="textureGalleryControls">
        <button id="prevTexturePage" onclick="changeTexturePage(-1)">â—€</button>
        <button id="nextTexturePage" onclick="changeTexturePage(1)">â–¶</button>
      </div>
    </div>

    <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>

    <div class="planet-buttons-row" style="margin-bottom:1rem;">
      <button id="editSelectedPlanetBtn" onclick="editSelectedPlanet()" disabled>ZmieÅ„ nazwÄ™</button>
      <button id="deleteSelectedPlanetBtn" class="lock-while-edit" onclick="deleteSelectedPlanet()" disabled>UsuÅ„ planetÄ™</button>
    </div>

    <!-- Ukryty kontener na edycjÄ™ -->
    <div id="editPlanetBox" style="display:none; margin-bottom:1rem;">
      <input type="text" id="editPlanetName" placeholder="Nowa nazwa planety" style="width:100%; margin-bottom:0.5rem;">
      <div style="display:flex; gap:0.5rem;">
        <button onclick="acceptEditPlanet()">Akceptuj</button>
        <button onclick="cancelEditPlanet()">Anuluj</button>
      </div>
    </div>

    <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>

    <!-- Pierwiastki planety -->
    <div id="planet-resources"></div>
  </div>
</div>
    <!-- ZakÅ‚adka PUNKTY -->
    <div id="punkty" class="tab-content">
      <div><label>Filtruj</label></div>
      <div style="height:0.5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <div id="pointFilters">
        <label>ZasÃ³b <input type="checkbox" class="pointFilter" value="ZasÃ³b" checked></label>
        <label>Baza <input type="checkbox" class="pointFilter" value="Baza" checked></label>
        <label>Ruiny <input type="checkbox" class="pointFilter" value="Ruiny" checked></label>
        <label>Struktura <input type="checkbox" class="pointFilter" value="Struktura" checked></label>
        <label>Inne <input type="checkbox" class="pointFilter" value="Inne" checked></label>
        <label>Bieguny <input type="checkbox" class="pointFilter" value="Pole" checked></label>
        <label>Moja lokalizacja <input type="checkbox" class="pointFilter" value="Moja" checked></label>
      </div>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <label>Filtry dodatkowe</label>
      <div style="height:0.5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <div id="extraFilters">
        <label>Wydobyty <input type="checkbox" class="extraFilter" value="Wydobyty" checked></label>
        <label>Odwiedzony <input type="checkbox" class="extraFilter" value="Odwiedzony" checked></label>
        <label>Niewydobyty <input type="checkbox" class="extraFilter" value="Niewydobyty" checked></label>
        <label>Nieodwiedzony <input type="checkbox" class="extraFilter" value="Nieodwiedzony" checked></label>
      </div>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <label>Sortuj:</label>
      <select id="sortPoints" onchange="refreshPointsList()">
        <option value="nameAsc">Nazwa Aâ€“Z</option>
        <option value="nameDesc">Nazwa Zâ€“A</option>
        <option value="type">Typ</option>
        <option value="newest">Najnowsze</option>
        <option value="oldest">Najstarsze</option>
      </select>
      <div style="height:5px; background:#102b56; margin:0.5rem 0; border-radius:4px;"></div>
      <ul id="pointsList"></ul>
    </div>
    <!-- ZakÅ‚adka DETALE PLANETY -->
    <div id="detale" class="tab-content">
      <label>Galaktyka</label>
		<div class="galaxy-selector">
  			<input type="text" id="galaxyInput" placeholder="Wybierz galaktykÄ™...">
  			<div id="galaxyDropdown" class="dropdown"></div>
	    </div>
	  <label>UkÅ‚ad gwiezdy</label><input type="text" id="detailStarSystem" />
      <label>UkÅ‚ad planetarny</label><input type="text" id="detailPlanetSystem" />
     
	 
	 <label for="detailBiome">Biom:</label>
<select id="detailBiome" onchange="updateBiomeAlias()">
  <option value="">-- Wybierz biom --</option>
  <option value="Bujny">Bujny</option>
  <option value="JaÅ‚owy">JaÅ‚owy</option>
  <option value="Martwy">Martwy</option>
  <option value="Egzotyczny">Egzotyczny</option>
  <option value="Mega Egzotyczny">Mega Egzotyczny</option>
  <option value="Spalony">Spalony</option>
  <option value="ZamroÅ¼ony">ZamroÅ¼ony</option>
  <option value="Toksyczny">Toksyczny</option>
  <option value="Napromieniowany">Napromieniowany</option>
  <option value="Bagno">Bagno</option>
  <option value="Wulkaniczny">Wulkaniczny</option>
  <option value="Gazowy Gigant">Gazowy Gigant</option>
</select>

<label for="detailBiomeAlias" style="margin-top:0.5rem; display:block;">Alternatywna nazwa biomu:</label>
<select id="detailBiomeAlias">
  <option value="">-- Wybierz alternatywnÄ… nazwÄ™ --</option>
</select>
	 	 
      <label>Pogoda</label>
      <select id="detailWeather">
        <option value="">-- wybierz --</option>
        <option>Brak atmosfery</option>
        <option>SÅ‚onecznie</option>
        <option>ChÅ‚odno</option>
        <option>MroÅºno</option>
        <option>CiepÅ‚o</option>
        <option>GorÄ…co</option>
        <option>Wilgotno</option>
        <option>Deszczowo</option>
        <option>Burzowo</option>
        <option>Radioaktywne</option>
        <option>Toksyczne</option>
        <option>Kwasyczne</option>
        <option>PyÅ‚owe</option>
        <option>Wulkaniczne</option>
        <option>Burze piaskowe</option>
        <option>Tornada</option>
        <option>Meteoryty</option>
        <option>Burze ogniste</option>
        <option>Wysokie ciÅ›nienie</option>
        <option>Niskie ciÅ›nienie</option>
        <option>Burze magnetyczne</option>
        <option>Burze elektryczne</option>
      </select>
      <label>StraÅ¼nicy</label>
      <select id="detailSentinels">
        <option value="">-- wybierz --</option>
        <option>Pasywne</option>
        <option>Brak</option>
        <option>Zrelaksowane</option>
        <option>Ograniczone</option>
        <option>Niskie</option>
        <option>Niskie bezpieczeÅ„stwo</option>
        <option>Minimalne</option>
        <option>Aktywne</option>
        <option>Åšrednie</option>
        <option>Standardowe</option>
        <option>Typowe</option>
        <option>UwaÅ¼ne</option>
      </select>
      <label>Flora</label>
      <select id="detailFlora">
        <option value="">-- wybierz --</option>
        <option>Brak</option>
        <option>Sporadyczna</option>
        <option>SkÄ…pa</option>
        <option>Åšrednia</option>
        <option>Obfita</option>
        <option>Ekstremalna</option>
      </select>
      <label>Fauna</label>
      <select id="detailFauna">
        <option value="">-- wybierz --</option>
        <option>Brak</option>
        <option>Sporadyczna</option>
        <option>SkÄ…pa</option>
        <option>Åšrednia</option>
        <option>Obfita</option>
        <option>Ekstremalna</option>
      </select>
      <label>Odkryty przez</label><input type="text" id="detailDiscovered" />
      <label>Tryb gry</label>
      <select id="detailMode">
        <option value="">-- wybierz --</option>
        <option>Normalny</option>
        <option>Kreatywny</option>
        <option>Survival</option>
        <option>Permadeath</option>
      </select>
      <label>Zaktualizowano</label><input type="text" id="detailUpdated" />
      <label>Koordynaty</label><input type="text" id="detailCoords" />
      <!-- Przycisk przejdÅº do NMS Portals -->
      <button onclick="window.open('https://nmsportals.github.io', '_blank')" style="margin-top:0.5rem; background:#1976d2; color:white; padding:0.5rem; border:none; border-radius:4px; cursor:pointer;"> PrzejdÅº do NMS Portals </button>
      <label>Notatki planety</label><textarea id="detailNotes"></textarea>
      <button onclick="savePlanetDetails()">Zapisz opis planety</button>
    </div>
  </div>
  <!-- Obszar wizualizacji globu -->
  <div id="globeWrapper" style="position: relative;">
    <!-- nagÅ‚Ã³wek overlay -->
    <div id="planetOverlayHeader"></div>
    <!-- nagÅ‚Ã³wek moja lokalizacja -->
    <div id="myLocationBox" style="position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); color:white; padding:0.5rem; border-radius:8px; z-index:10;">
      <div style="font-weight:bold; margin-bottom:0.5rem;">Moja lokalizacja</div>
      <label>X: <input type="number" id="myLat" step="0.01" style="width:70px;"></label>
      <label>Y: <input type="number" id="myLng" step="0.01" style="width:70px;"></label>
    </div>
    <!-- glob -->
    <div id="globeViz"></div>
    <!-- Panel z listÄ… planet po prawej stronie -->
    
    <div id="planetSidebar">
  <h3>Lista planet</h3>
  <div id="planetListSidebar"></div>
</div>

<div id="galaxySidebar">
  <h3>Galaktyki</h3>
  <ul id="galaxyList"></ul>
</div>
    <!-- Przycisk do pokazywania/ukrywania panelu -->
   <button id="togglePlanetSidebarBtn">â–¶</button>
   
     <!-- Info o planecie -->
<div id="planetMiniPanel">
		  <!-- Przycisk do pokazywania/ukrywania minipanelu -->
	  <button id="toggleMiniPanelBtn">â–¼</button>
  <div id="miniPanelBiome"></div>
  <div id="miniPanelResources"></div>
  <div id="miniPanelSentinels"></div>
</div>
   
   <!-- Panel z notatkami punktu -->
<div id="pointNotesPanel"></div>
   
</div>
   
<script>
let atlas = {};
let planetDetails = {}; // szczegÃ³Å‚y kaÅ¼dej planety
let planetData = []; // lista planet z dodatkowymi info
let currentPlanet = null; // aktualnie wybrana planeta
let pointScale = parseFloat(document.getElementById("pointScale").value);
let editIndex = null;
let pointsDistanceMultiplier = 1;
let globeZoomMultiplier = 1;
let autoRotate = false;
let rotateSpeed = 0.001; // prÄ™dkoÅ›Ä‡ obrotu w radianach na frame
let myLocationPoint = null;  
let isEditing = false; // globalna flaga
let highlightTimeout = null;
let headerLock = true; // blokada na starcie celem zablokowania moÅ¼liwoÅ›ci nadpisania nagÅ‚Ã³wka
		
////////////////////////////////////////////////////////////////////
//----------------- ZakÅ‚adki i inne elementy UI -----------------//
//////////////////////////////////////////////////////////////////// 

// ZakÅ‚adki
function openTab(tabId) {
  // zawsze chowaj sub-tab wyszukiwania po zmianie zakÅ‚adki
  document.getElementById("planetSearchTab").style.display = "none";
  const planetMain = document.getElementById("planetMainTab");
  if (planetMain) planetMain.style.display = "block";

  // ukryj wszystkie zakÅ‚adki
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  
  // usuÅ„ active z przyciskÃ³w
  document.querySelectorAll("#tabs button").forEach(el => el.classList.remove("active"));

  // aktywuj odpowiedniÄ… zakÅ‚adkÄ™
  const tab = document.getElementById(tabId);
  if (tab) tab.classList.add("active");

  // zaznacz przycisk zakÅ‚adki jako active
  document.querySelectorAll("#tabs button").forEach(btn => {
    if (btn.getAttribute("onclick") && btn.getAttribute("onclick").includes(`'${tabId}'`)) {
      btn.classList.add("active");
    }
  });

  // odÅ›wieÅ¼ nagÅ‚Ã³wek planety 
  updateCurrentPlanetHeader();
}

function showPlanetSearchTab() {
  document.getElementById("planetMainTab").style.display = "none";
  document.getElementById("planetSearchTab").style.display = "block";
}

function backToPlanets() {
  document.getElementById("planetSearchTab").style.display = "none";
  document.getElementById("planetMainTab").style.display = "block";
}
  
//zmiana nagÅ‚Ã³wka z nazwÄ… planety
function updateCurrentPlanetHeader() {
  const overlay = document.getElementById("planetOverlayHeader");
  if (!overlay) return;

  // JeÅ›li blokada jest aktywna i currentPlanet jest null â†’ ustaw raz i zablokuj nadpisanie
  if (headerLock && !currentPlanet) {
    overlay.textContent = "Brak wybranej planety";
    return; // wychodzimy bez nadpisywania dalej
  }

  // Normalne dziaÅ‚anie po starcie
  overlay.textContent = currentPlanet
    ? `${currentPlanet}`
    : "Brak wybranej planety";
}

// odblokowanie blokady po starcie (0ms po zaÅ‚adowaniu strony)
document.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    headerLock = false;
    updateCurrentPlanetHeader(); // odÅ›wieÅ¼ jeszcze raz po zdjÄ™ciu blokady
  }, 0);
});

function updateNoPlanetsMessage() {
  const msg = document.getElementById("noPlanetsMessage");
  const planets = Object.keys(atlas);
  if (planets.length === 0) {
    msg.style.display = "block";
  } else {
    msg.style.display = "none";
  }
  updateCurrentPlanetHeader();
}
  
// Detale planety 

function loadPlanetDetails(){
  if(!currentPlanet) return;
  const details = planetDetails[currentPlanet] || {};

  // galaxyInput - selektor z autouzupeÅ‚nianiem)
  const galaxyEl = document.getElementById("galaxyInput");
  if (galaxyEl) {
    galaxyEl.value = details.galaxy || "";
    // synchronizuj zmiennÄ… globalnÄ…
    currentGalaxy = details.galaxy || currentGalaxy;
  }

  const starSystemEl = document.getElementById("detailStarSystem");
  const planetSystemEl = document.getElementById("detailPlanetSystem");

  starSystemEl.value = details.starSystem || "";
  planetSystemEl.value = details.planetSystem || "";

  // jeÅ›li to ksiÄ™Å¼yc â€“ blokujemy edycjÄ™ pÃ³l ukÅ‚adÃ³w
  if (details.parentPlanetId) {
    starSystemEl.disabled = true;
    planetSystemEl.disabled = true;
    starSystemEl.style.backgroundColor = "#f0f0f0"; // wyszarzenie
    planetSystemEl.style.backgroundColor = "#f0f0f0";
  } else {
    starSystemEl.disabled = false;
    planetSystemEl.disabled = false;
    starSystemEl.style.backgroundColor = "";
    planetSystemEl.style.backgroundColor = "";
  }
  
   document.getElementById("detailBiome").value = details.biome || "";
  updateBiomeAlias();
  document.getElementById("detailBiomeAlias").value = details.biomeAlias || "";
  document.getElementById("detailWeather").value = details.weather || "";
  document.getElementById("detailSentinels").value = details.sentinels || "";
  document.getElementById("detailFlora").value = details.flora || "";
  document.getElementById("detailFauna").value = details.fauna || "";
  document.getElementById("detailDiscovered").value = details.discovered || "";
  document.getElementById("detailMode").value = details.mode || "";
  document.getElementById("detailUpdated").value = details.updated || "";
  document.getElementById("detailCoords").value = details.coords || "";
  document.getElementById("detailNotes").value = details.notes || "";
	
	// PrzywrÃ³Ä‡ checkboxy pierwiastkÃ³w
  if (icons && icons.length) {
    icons.forEach(res => {
      const checkbox = document.getElementById(`resCheckbox-${res.name}`);
      if (checkbox) {
        checkbox.checked = details.resources?.includes(res.name) || false;
      }
    });
  }
}

function savePlanetDetails(){
  if(!currentPlanet) return;

  // pobierz galaktykÄ™ z inputa (fallback na currentGalaxy)
  const galaxyEl = document.getElementById("galaxyInput");
  const galaxyVal = (galaxyEl && galaxyEl.value) ? galaxyEl.value : (currentGalaxy || "");
  let starSystemVal = document.getElementById("detailStarSystem").value.trim();
  let planetSystemVal = document.getElementById("detailPlanetSystem").value.trim();

  // JeÅ›li podano tylko planetSystem, sprÃ³buj odnaleÅºÄ‡ istniejÄ…cy starSystem, gdzie ten planetSystem juÅ¼ wystÄ™puje
  if (!starSystemVal && planetSystemVal) {
    for (const details of Object.values(planetDetails)) {
      if (details.planetSystem === planetSystemVal && details.starSystem) {
        starSystemVal = details.starSystem;
        break;
      }
    }
  }

  // JeÅ›li podano starSystem ale nie planetSystem â€” blokujemy zapisu (zgodnie z reguÅ‚Ä…)
  if (starSystemVal && !planetSystemVal) {
    alert("WprowadÅº nazwÄ™ ukÅ‚adu planetarnego aby poprawnie wyÅ›wietliÄ‡ planetÄ™ na liÅ›cie!");
    return;
  }
    //Sprawdza, czy w ogÃ³le istnieje wpis w planetDetails dla aktualnej planety/ksiÄ™Å¼yca.
    //JeÅ›li istnieje â€” przypisuje jego dane do existing.
    //JeÅ›li nie istnieje (np. nowo utworzony obiekt jeszcze nie ma zapisanych detali) â€” tworzy pusty obiekt {} jako â€žbezpieczny fallbackâ€.
       const existing = planetDetails[currentPlanet] || {};
	
	const biome = document.getElementById("detailBiome").value;
	const biomeAlias = document.getElementById("detailBiomeAlias").value;
	// zachowaj istniejÄ…ce resources jeÅ›li sÄ…
      const existingResources = planetDetails[currentPlanet]?.resources || [];

	// ðŸ”’ Zachowujemy typ obiektu (czy to ksiÄ™Å¼yc, czy planeta)
	  const isMoon = existing.isMoon || false;
	  const parentPlanet = existing.parentPlanet || null;
	  const system = existing.system || null;
	  const starSystem = existing.starSystem || null;





  planetDetails[currentPlanet] = {
    galaxy: galaxyVal,
    starSystem: starSystemVal,
    planetSystem: planetSystemVal || "Nieznany", // jeÅ›li brak â€“ lÄ…duje w â€žNieznanyâ€
    biome: biome,
    biomeAlias: biomeAlias,
    weather: document.getElementById("detailWeather").value,
    sentinels: document.getElementById("detailSentinels").value,
    flora: document.getElementById("detailFlora").value,
    fauna: document.getElementById("detailFauna").value,
    discovered: document.getElementById("detailDiscovered").value,
    mode: document.getElementById("detailMode").value,
    updated: document.getElementById("detailUpdated").value,
    coords: document.getElementById("detailCoords").value,
    notes: document.getElementById("detailNotes").value,
	resources: existingResources,
	
	// przywrÃ³cenie identyfikatora rodzica i flagi ksiÄ™Å¼yca
	parentPlanetId: existing.parentPlanetId || null,
	isMoon: !!existing.parentPlanetId
  };
 
 // synchronizuj globalnÄ… zmiennÄ… (opcjonalne, ale wygodne)
  currentGalaxy = galaxyVal;

	// automatyczne nadpisanie ukÅ‚adÃ³w dla ksiÄ™Å¼ycÃ³w
	  Object.keys(planetDetails).forEach(name => {
		const moon = planetDetails[name];
		if (moon.parentPlanetId === currentPlanet) {
		  moon.galaxy = galaxyVal;
		  moon.starSystem = starSystemVal;
		  moon.planetSystem = planetSystemVal || "Nieznany";
		}
	  });


  alert("Opis zapisany!");
  refreshPlanetList();
  updateCurrentPlanetHeader();
  refreshPlanetSidebar();
  refreshGalaxySidebar();
	updatePlanetMiniPanel();
}


// Renderowanie list planet na wizualizacji globu
function refreshPlanetSidebar() {
  const sidebar = document.getElementById("planetSidebar");
  if (!sidebar) return;

  // JeÅ›li panel jest ukryty, nic nie rÃ³b aby nie blokowaÄ‡ pokaÅ¼ / ukryj listy planet
  if (sidebar.classList.contains("hidden")) return;

  if (!atlas) return;

  const listContainer = document.getElementById("planetListSidebar");
  if (!listContainer) return;
  listContainer.innerHTML = ""; // WAÅ»NE: czyÅ›cimy listÄ™ przed ponownym renderowaniem

  const grouped = getGroupedPlanets(); // zachowuje ukÅ‚ady gwiezdne i systemy planetarne

  grouped.forEach(starGroup => {
    // filtrujemy caÅ‚e ukÅ‚ady gwiezdne wg wybranej galaktyki
    const hasPlanetsInGalaxy = starGroup.planetSystems.some(sys =>
      sys.planets.some(planetName => {
        if (!currentGalaxy) return true; // jeÅ›li nic nie wybrano, pokaÅ¼ wszystkie
        return planetDetails[planetName]?.galaxy === currentGalaxy;
      })
    );

    if (!hasPlanetsInGalaxy) return; // pomiÅ„ ukÅ‚ad gwiezdny, jeÅ›li w tej galaktyce brak planet

   // nagÅ‚Ã³wek ukÅ‚adu gwiezdnego
const starHeader = document.createElement("h5");
starHeader.textContent = starGroup.starSystem === "Nieznany"
  ? "Nieznany ukÅ‚ad gwiezdny"
  : starGroup.starSystem;

starHeader.style.color = starGroup.starSystem === "Nieznany" ? "#aaa" : "#ffcc00";

listContainer.appendChild(starHeader);

    // teraz iteracja po systemach planetarnych wewnÄ…trz tego ukÅ‚adu gwiezdnego
    starGroup.planetSystems.forEach(planetSystem => {
      // filtrujemy planety tego systemu wg planetDetails (GALAKTYKA)
      const planetsInGalaxy = planetSystem.planets.filter(planetName => {
        if (!currentGalaxy) return true; // jeÅ›li nic nie wybrano, pokaÅ¼ wszystkie
        return planetDetails[planetName]?.galaxy === currentGalaxy;
      });

      if (planetsInGalaxy.length === 0) return; // pomiÅ„ system, jeÅ›li nie ma pasujÄ…cych planet

      // nagÅ‚Ã³wek systemu
		const header = document.createElement("h4");
		header.textContent = planetSystem.name === "Nieznany"
		  ? "Nieznany ukÅ‚ad planetarny"
		  : planetSystem.name;
		header.style.fontSize = "0.9rem";
		header.style.margin = "0.5rem 0";
		header.style.color = planetSystem.name === "Nieznany" ? "#aaa" : "#ffcc00";
		
		// WYÅšRODKUJ tylko jeÅ›li to "Nieznany ukÅ‚ad planetarny"
		if (planetSystem.name === "Nieznany") {
		  header.style.textAlign = "center";
		}
		
		listContainer.appendChild(header);

      // tylko planety gÅ‚Ã³wne (nie ksiÄ™Å¼yce)
		const mainPlanets = planetsInGalaxy.filter(p => !planetDetails[p].parentPlanetId);
		mainPlanets.forEach(planetName => {
        const li = document.createElement("li");
        li.style.cursor = "pointer";
        li.style.padding = "2px 0";
        li.textContent = planetName;

        // podÅ›wietlenie wybranej planety
        if (planetName === currentPlanet) {
          li.style.fontWeight = "bold";
          li.style.color = "#1976d2";
        }

        li.onclick = () => {
          currentPlanet = planetName;
          updateCurrentPlanetHeader();
          addPoles(planetName);
          refreshGlobePoints();
          globe.htmlElementsData(atlas[planetName].filter(pt => pt.type === "Pole"));
          refreshPointsList();
          selectPlanet(planetName);
          updateSelectedPlanetButtons();
          refreshPlanetSidebar(); // odÅ›wieÅ¼amy sidebar, Å¼eby podÅ›wietlenie dziaÅ‚aÅ‚o
          loadPlanetDetails();
			renderPlanetResourcesPanel();
			updatePlanetMiniPanel();
        };

        listContainer.appendChild(li);
		
		const moons = Object.keys(planetDetails).filter(m => planetDetails[m].parentPlanetId === planetName);
			moons.forEach(moonName => {
			  const moonLi = document.createElement("li");
			  moonLi.textContent = moonName;
			  moonLi.style.fontSize = "0.8rem"; // mniejsza czcionka
			  moonLi.style.marginLeft = "1rem"; // wciÄ™cie
			  moonLi.style.fontStyle = "italic";
			  moonLi.style.cursor = "pointer";
				// podÅ›wietlenie
				  if (moonName === currentPlanet) {
					moonLi.style.fontWeight = "bold";
					moonLi.style.color = "#1976d2"; // ciemnoniebieski
				  }
			  moonLi.onclick = () => {
				currentPlanet = moonName;
				updateCurrentPlanetHeader();
				addPoles(moonName);
				refreshGlobePoints();
				globe.htmlElementsData(atlas[moonName].filter(pt => pt.type === "Pole"));
				refreshPointsList();
				selectPlanet(moonName);
				updateSelectedPlanetButtons();
				refreshPlanetSidebar();
				loadPlanetDetails();
				renderPlanetResourcesPanel();
				updatePlanetMiniPanel();
			  };

			  listContainer.appendChild(moonLi);
			});

		
      });
    });
  });
}
 
// Funkcja do toggle panelu
function togglePlanetSidebar() {
  const sidebar = document.getElementById("planetSidebar");
  const galaxySidebar = document.getElementById("galaxySidebar"); // panel galaktyk
  const btn = document.getElementById("togglePlanetSidebarBtn");

  sidebar.classList.toggle("hidden");
  galaxySidebar.classList.toggle("hidden");

  if (sidebar.classList.contains("hidden")) {
    btn.textContent = "â—€"; // panel ukryty â†’ strzaÅ‚ka w prawo
  } else {
    btn.textContent = "â–¶"; // panel widoczny â†’ strzaÅ‚ka w lewo
    refreshPlanetSidebar();
	refreshGalaxySidebar();
  }
}

// PodÅ‚Ä…cz przycisk
document.getElementById("togglePlanetSidebarBtn").addEventListener("click", togglePlanetSidebar);

// Generator nazw
function generatePlanetName() {
  const syllables = [
    // krÃ³tkie, twarde
    "Ar", "As", "At", "Az", "Bal", "Bel", "Bor", "Bran", "Cal", "Cer",
    "Cor", "Cyn", "Dal", "Dar", "Den", "Dor", "Dur", "El", "Er", "Eth",
    "Fal", "Fen", "For", "Gal", "Gar", "Gor", "Grav", "Hal", "Hor", "Hun",
    "Ira", "Ist", "Jar", "Jor", "Kal", "Kar", "Kor", "Kri", "Kul", "Lar",
    "Len", "Lor", "Lun", "Mal", "Mar", "Mer", "Mor", "Mun", "Nal", "Nar",
    "Nel", "Nor", "Nyr", "Oph", "Or", "Ost", "Pal", "Par", "Pel", "Por",
    "Pyr", "Qua", "Quel", "Quor", "Rad", "Ral", "Ran", "Rel", "Rev", "Rho",
    "Rin", "Ryn", "Sal", "Sar", "Sel", "Sen", "Ser", "Sha", "Sol", "Sor",
    "Sul", "Syn", "Tal", "Tan", "Tar", "Tel", "Tor", "Tyr", "Ula", "Um",
    "Ur", "Val", "Var", "Vel", "Ven", "Ver", "Vor", "Vul", "Xan", "Xen",
    "Xor", "Yl", "Yra", "Zal", "Zan", "Zar", "Zen", "Zor", "Zyn", "Zyr"
  ];

  const suffixes = [
    "Prime","Major","Minor","Alpha","Beta","Gamma","Delta",
    "Omega","Sigma","Tau"
  ];

  // Losuj 2â€“3 sylaby
  const parts = [];
  const count = Math.random() < 0.5 ? 2 : 3; 
  for (let i = 0; i < count; i++) {
    const s = syllables[Math.floor(Math.random() * syllables.length)];
    // Pierwsza sylaba = z duÅ¼ej litery, kolejne = z maÅ‚ej
    if (i === 0) {
      parts.push(s.charAt(0).toUpperCase() + s.slice(1).toLowerCase());
    } else {
      parts.push(s.toLowerCase());
    }
  }

  let name = parts.join("");

  // 30% szans na dodanie ozdobnika
  if (Math.random() < 0.3) {
    name += " " + suffixes[Math.floor(Math.random() * suffixes.length)];
  }

  // Pierwsza litera wielka (dla pewnoÅ›ci)
  name = name.charAt(0).toUpperCase() + name.slice(1);

  // Wstaw do pola tekstowego
  document.getElementById("newPlanetName").value = name;
  checkNewPlanetInput();
}

const biomeAliases = {
  "Bujny": "Deszczowy, Bujny, Tropikalny, Zielonkawy, Rajsky, Umiarkowana, Wilgotny, PoroÅ›niÄ™ty, KwitnÄ…cy, Trawiasty, Obfity",
  "JaÅ‚owy": "JaÅ‚owy, Pustynny, Skalisty, Ponury, WyschniÄ™ty, OpustoszaÅ‚y, Pylisty, Bezkresny, Smagany wiatrem",
  "Martwy": "Katastrofa Terraformacji, Martwy, Pusty, Pustkowie, Bez Å¼ycia, Porzucony, Niezdatny do Å¼ycia, Niska atmosfera, Bezatmosferyczny, Opuszczony",
  "Egzotyczny": "Szczelinowy, Åšwietlny, Przerwany, TrzaskajÄ…cy, Kolczasty, Szkieletowy, BulgoczÄ…cy, PieniÄ…cy siÄ™, Pienisty, Profilowany, Okablowany, Sieciowy, Mechaniczny, Metaliczny, Metalurgiczny, SzeÅ›ciokÄ…tny, PÅ‚ytowy, Åuskowy, Grzybowy, Zarodnikowy, PÅ‚etwowy, Ostrzowy, Pokryty skorupami, Zasklepiony, KostniejÄ…cy, SkamieniaÅ‚y, SÅ‚upowy, Rozszczepiony, Kolumnowy, ZmiaÅ¼dÅ¼ony, PÄ™kniÄ™ty, Fragmentaryczny, ZwapniaÅ‚y, Karmazynowy, Anomalia Planetarna, Niesprawny, Zainfekowany, [ZASTRZEÅ»ONE], Szklany, Spragniony, Skazany, Wymazany, Tymczasowy, Uszkodzony",
  "Mega Egzotyczny": "Karmazynowy, Anomalia Planetarna - Czerwony biom, Anomalia Planetarna - Zielony biom, Anomalia Planetarna - Niebieski biom, Zaginiona ZieleÅ„, Zaginiony BÅ‚Ä™kit, Zaginiona CzerwieÅ„, [ZASTRZEÅ»ONE] - Czerwony biom, [ZASTRZEÅ»ONE] - Zielony biom, [ZASTRZEÅ»ONE] - Niebieski biom, Wykryto KorupcjÄ™ GwiezdnÄ… - Czerwony biom, Wykryto KorupcjÄ™ GwiezdnÄ… - Zielony biom, Wykryto KorupcjÄ™ GwiezdnÄ… - Niebieski biom, Chromatyczna MgÅ‚a - Czerwony biom, Chromatyczna MgÅ‚a - Zielony biom, Chromatyczna MgÅ‚a - Nieibeski biom, ZÅ‚oÅ›liwa Anomalia, Surowa Niebieska Planeta, Czerwonawy Glob, Toksyczna Anomalia, ZamarzniÄ™ta Anomalia, SzkarÅ‚atny, Skazany Szmaragd, Azur, Krew, Nawiedzony Emeril, Cerulean, Ciemnoczerwone Wino, Åšmiertelna Zielona Anomalia, Ultramaryna",
  "Spalony": "ZwÄ™glony, Suchy, Spalony, GorÄ…cy, Ognisty, WrzÄ…cy, Wysoka Temperatura, ParujÄ…cy, RozÅ¼arzony, Poparzeniowy",
  "ZamroÅ¼ony": "ZamarzniÄ™ty, Pokryty Lodem, Arktyczny, Lodowcowy, Ponizej Zera, Lodowy, MroÅºny, Lodowaty, Zimowy, Hiperborejski",
  "Toksyczny": "Toksyczny, TrujÄ…cy, Szkodliwy, Korozyjny, Kwasowy, Å»rÄ…cy, Ostry, Zniszczony, Miasmatyczny, RozkÅ‚adajÄ…cy siÄ™",
  "Napromieniowany": "Napromieniowany, Radioaktywny, SkaÅ¼ony, Nuklearny, Izotopowy, RozkÅ‚adajÄ…cy siÄ™ Nuklearnie, Wysokogamowy, Å¹rÃ³dÅ‚o Wysokiego Promieniowania, Nadkrytyczny, Wysokoenergetyczny",
  "Bagno": "Bagienny, Moczarowy, Egzotyczny, Mglisty, Zamglony, BÅ‚otnisty, NieskoÅ„czone Bagno, GrzÄ™zawisko, Lekko Zamglony, Pochmurny, Parowy, Odorem, MÄ™tny, Przemoczony",
  "Wulkaniczny": "Lawa, Magma, Wybuchowy, Wulkaniczny, Pokryty PopioÅ‚em, Popielaty, Tektoniczny, Niestabilny, Burzliwy, Roztopiony, RozÅ¼arzony, NadchodzÄ…ca Detonacja JÄ…dra, Obsydianowy, Bazaltowy",
  "Gazowy Gigant": "Gazowy Gigant"
};

// Aktualizacja alternatywnych nazw
function updateBiomeAlias() {
  const biomeSelect = document.getElementById("detailBiome");
  const aliasSelect = document.getElementById("detailBiomeAlias");
  const biome = biomeSelect.value;

  aliasSelect.innerHTML = '<option value="">-- Wybierz alternatywnÄ… nazwÄ™ --</option>';

  if (biome && biomeAliases[biome]) {
    biomeAliases[biome].split(',').forEach(name => {
      const opt = document.createElement('option');
      opt.value = name.trim();
      opt.textContent = name.trim();
      aliasSelect.appendChild(opt);
    });
  }
}




////////////////////////////////////////////////////////////////////
//------------------- Sidebar galaktyk ----------------------------//
////////////////////////////////////////////////////////////////////

function refreshGalaxySidebar() {
  const galaxyList = document.getElementById("galaxyList");
  galaxyList.innerHTML = "";

  // zbierz unikalne galaktyki z detali planet
  const galaxies = [...new Set(Object.values(planetDetails)
    .map(d => d.galaxy)
    .filter(Boolean))];

  // jeÅ›li nic nie ma, pokaÅ¼ Euclid jako domyÅ›lnÄ…
  if (galaxies.length === 0) galaxies.push("Euclid");

  galaxies.forEach(g => {
    const li = document.createElement("li");
    li.textContent = g;
    li.style.cursor = "pointer";

    // podÅ›wietlenie wybranej galaktyki
        if (g === currentGalaxy) {
          li.style.fontWeight = "bold";
          li.style.color = "#1976d2";
        }

    li.onclick = () => {
      currentGalaxy = g;          // ustawiamy globalnÄ… zmiennÄ…
      refreshPlanetSidebar();     // odÅ›wieÅ¼ listÄ™ planet dla tej galaktyki
      refreshGalaxySidebar();

      // ustaw input galaktyki w szczegÃ³Å‚ach planety (jeÅ›li jest aktywna planeta)
      const galaxyInput = document.getElementById("galaxyInput");
      if (galaxyInput) {
        galaxyInput.value = currentGalaxy;
      }
     };
    galaxyList.appendChild(li);
  });
}

// Selektor galaktyk
const galaxies = [
  "Euclid", "Hilbert Dimension", "Calypso", "Hesperius Dimension", "Hyades", "Ickjamatew", "Budullangr", "Kikolgallr", "Eltiensleen", "Eissentam", "Elkupalos", "Aptarkaba", "Ontiniangp", "Odiwagiri", "Ogtialabi", "Muhacksonto", "Hitonskyer", "Rerasmutul", "Isdoraijung", "Doctinawyra", "Loychazinq", "Zukasizawa", "Ekwathore", "Yeberhahne", "Twerbetek", "Sivarates", "Eajerandal", "Aldukesci", "Wotyarogii", "Sudzerbal", "Maupenzhay", "Sugueziume", "Brogoweldian", "Ehbogdenbu", "Ijsenufryos", "Nipikulha", "Autsurabin", "Lusontrygiamh", "Rewmanawa", "Ethiophodhe", "Urastrykle", "Xobeurindj", "Oniijialdu", "Wucetosucc", "Ebyeloof", "Odyavanta", "Milekistri", "Waferganh", "Agnusopwit", "Teyaypilny", "Zalienkosm", "Ladgudiraf", "Mushonponte", "Amsentisz", "Fladiselm", "Laanawemb", "Ilkerloor", "Davanossi", "Ploehrliou", "Corpinyaya", "Leckandmeram", "Quulngais", "Nokokipsechl", "Rinblodesa", "Loydporpen", "Ibtrevskip", "Elkowaldb", "Heholhofsko", "Yebrilowisod", "Husalvangewi", "Ovna'uesed", "Bahibusey", "Nuybeliaure", "Doshawchuc", "Ruckinarkh", "Thorettac", "Nuponoparau", "Moglaschil", "Uiweupose", "Nasmilete", "Ekdaluskin", "Hakapanasy", "Dimonimba", "Cajaccari", "Olonerovo", "Umlanswick", "Henayliszm", "Utzenmate", "Umirpaiya", "Paholiang", "Iaereznika", "Yudukagath", "Boealalosnj", "Yaevarcko", "Coellosipp", "Wayndohalou", "Smoduraykl", "Apmaneessu", "Hicanpaav", "Akvasanta", "Tuychelisaor", "Rivskimbe", "Daksanquix", "Kissonlin", "Aediabiel", "Ulosaginyik", "Roclaytonycar", "Kichiaroa", "Irceauffey", "Nudquathsenfe", "Getaizakaal", "Hansolmien", "Bloytisagra", "Ladsenlay", "Luyugoslasr", "Ubredhatk", "Cidoniana", "Jasinessa", "Torweierf", "Saffneckm", "Thnistner", "Dotusingg", "Luleukous", "Jelmandan", "Otimanaso", "Enjaxusanto", "Sezviktorew", "Zikehpm", "Bephembah", "Broomerrai", "Meximicka", "Venessika", "Gaiteseling", "Zosakasiro", "Drajayanes", "Ooibekuar", "Urckiansi", "Dozivadido", "Emiekereks", "Meykinunukur", "Kimycuristh", "Roansfien", "Isgarmeso", "Daitibeli", "Gucuttarik", "Enlaythie", "Drewweste", "Akbulkabi", "Homskiw", "Zavainlani", "Jewijkmas", "Itlhotagra", "Podalicess", "Hiviusauer", "Halsebenk", "Puikitoac", "Gaybakuaria", "Grbodubhe", "Rycempler", "Indjalala", "Fontenikk", "Pasycihelwhee", "Ikbaksmit", "Telicianses", "Oyleyzhan", "Uagerosat", "Impoxectin", "Twoodmand", "Hilfsesorbs", "Ezdaranit", "Wiensanshe", "Ewheelonc", "Litzmantufa", "Emarmatosi", "Mufimbomacvi", "Wongquarum", "Hapirajua", "Igbinduina", "Wepaitvas", "Sthatigudi", "Yekathsebehn", "Ebedeagurst", "Nolisonia", "Ulexovitab", "Iodhinxois", "Irroswitzs", "Bifredait", "Beiraghedwe", "Yeonatlak", "Cugnatachh", "Nozoryenki", "Ebralduri", "Evcickcandj", "Ziybosswin", "Heperclait", "Sugiuniam", "Aaseertush", "Uglyestemaa", "Horeroedsh", "Drundemiso", "Ityanianat", "Purneyrine", "Dokiessmat", "Nupiacheh", "Dihewsonj", "Rudrailhik", "Tweretnort", "Snatreetze", "Iwundaracos", "Digarlewena", "Erquagsta", "Logovoloin", "Boyaghosganh", "Kuolungau", "Pehneldept", "Yevettiiqidcon", "Sahliacabru", "Noggalterpor", "Chmageaki", "Veticueca", "Vittesbursul", "Nootanore", "Innebdjerah", "Kisvarcini", "Cuzcogipper", "Pamanhermonsu", "Brotoghek", "Mibittara", "Huruahili", "Raldwicarn", "Ezdartlic", "Badesclema", "Isenkeyan", "Iadoitesu", "Yagrovoisi", "Ewcomechio", "Inunnunnoda", "Dischiutun", "Yuwarugha", "Ialmendra", "Reponudrle", "Rinjanagrbo", "Zeziceloh", "Oeileutasc", "Zicniijinis", "Dugnowarilda", "Neuxoisan", "Ilmenhorn", "Rukwatsuku", "Nepitzaspru", "Chcehoemig", "Haffneyrin", "Uliciawai", "Tuhgrespod", "Iousongola", "Odyalutai"
];

let currentGalaxy = "Euclid"; // domyÅ›lna

document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("galaxyInput");
  const dropdown = document.getElementById("galaxyDropdown");

  // ustaw wartoÅ›Ä‡ inputa i odÅ›wieÅ¼ sidebary na starcie
  if (input) input.value = currentGalaxy || "";
  refreshGalaxySidebar();
  refreshPlanetSidebar();

  if (!input || !dropdown) return;

  // pokazanie listy przy wpisywaniu
  input.addEventListener("input", () => {
    const val = input.value.toLowerCase();
    dropdown.innerHTML = "";

    if (!val) {
      dropdown.style.display = "none";
      return;
    }

    const filtered = galaxies.filter(g => g.toLowerCase().includes(val));

    if (filtered.length === 0) {
      dropdown.style.display = "none";
      return;
    }

    filtered.forEach(g => {
      const option = document.createElement("div");
      option.textContent = g;
      option.addEventListener("click", () => {
        input.value = g;
        currentGalaxy = g; // ustawiamy aktualnÄ… galaktykÄ™
        dropdown.style.display = "none";
        // od razu odÅ›wieÅ¼amy listy aby widaÄ‡ byÅ‚o filtracjÄ™
        refreshGalaxySidebar();
        refreshPlanetSidebar();
        console.log("Wybrano galaktykÄ™:", currentGalaxy);
      });
      dropdown.appendChild(option);
    });

    dropdown.style.display = "block";
  });

  // zamkniÄ™cie dropdownu po klikniÄ™ciu poza
  document.addEventListener("click", e => {
    if (!e.target.closest(".galaxy-selector")) {
      dropdown.style.display = "none";
    }
  });
});


////////////////////////////////////////////////////////////////////
//------------------ Planety, lista, tworzenie -------------------//
//////////////////////////////////////////////////////////////////// 
  
// Dodawanie nowych planet
  function checkNewPlanetInput() {
  const input = document.getElementById("newPlanetName");
  const button = document.getElementById("addPlanetBtn");
  button.disabled = input.value.trim() === "";
}
// Po zaÅ‚adowaniu DOM od razu sprawdzamy input i ustawiamy stan przycisku
document.addEventListener("DOMContentLoaded", () => {
  checkNewPlanetInput(); // ustawia disabled zgodnie z zawartoÅ›ciÄ… input
});
  
  //Tworzy teksturÄ™ o rozmairze 1 piksel x 1 piksel o zadanym kolorze i zmienia na base64
function hexToBase64Texture(hex) {
  // Tworzymy canvas 1x1
  const canvas = document.createElement("canvas");
  canvas.width = 1;
  canvas.height = 1;
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = hex;
  ctx.fillRect(0, 0, 1, 1);

  // Zamiana na base64 PNG
  return canvas.toDataURL("image/png");
}
  
function addNewPlanet() {
  const input = document.getElementById("newPlanetName");
  const name = input.value.trim();
  if (!name) return;

  const isMoonCheckbox = document.getElementById("isMoonCheckbox");
  const isMoon = isMoonCheckbox.checked;

 if (atlas[name]) {
    alert("Planeta / KsiÄ™Å¼yc o tej nazwie juÅ¼ istnieje!");
    return;
  }

  let parentPlanet = null;

  if (isMoon) {
    // przypadek 1: mamy wybranÄ… planetÄ™ â€” OK
    if (currentPlanet && !planetDetails[currentPlanet]?.parentPlanetId) {
      parentPlanet = currentPlanet;
    }
    // przypadek 2: mamy wybranego ksiÄ™Å¼yca â€” przypisz nowy do planety-rodzica
    else if (currentPlanet && planetDetails[currentPlanet]?.parentPlanetId) {
      parentPlanet = planetDetails[currentPlanet].parentPlanetId;
      alert(
        `Wybrany obiekt to ksiÄ™Å¼yc â€” nowy ksiÄ™Å¼yc zostanie przypisany do planety "${parentPlanet}".`
      );
    }
    // przypadek 3: nie wybrano nic
    else {
      alert("Wybierz planetÄ™, do ktÃ³rej chcesz przypisaÄ‡ nowy ksiÄ™Å¼yc!");
      return;
    }
  }

  // wybÃ³r koloru
  const colorHex = document.getElementById("PlanetColor").value || "#000000";
  const textureBase64 = hexToBase64Texture(colorHex);

  // Dodajemy do atlasu
  atlas[name] = [];
  addPoles(name);

  // Dodaj pustÄ… strukturÄ™ detali od razu:
  planetDetails[name] = {
    galaxy: currentGalaxy,
    starSystem: isMoon ? planetDetails[parentPlanet]?.starSystem || "" : "",
    planetSystem: isMoon ? planetDetails[parentPlanet]?.planetSystem || "" : "",
    resources: [],
    biome: "",
    weather: "",
    sentinels: "",
    flora: "",
    fauna: "",
    discovered: "",
    mode: "",
    updated: "",
    coords: "",
    notes: "",
    parentPlanetId: parentPlanet,
    isMoon: !!parentPlanet
  };

  // Dodanie nowego wpisu do planetData
  planetData.push({
    name: name,
    texture: textureBase64,  // Przypisanie koloru planety w formie tekstury
    extraInfo: {}, // miejsce na dodatkowe, niestandardowe dane planety
    createdAt: Date.now() //automatycznie zapisany czas dodania planety
  });

	if (!isMoon) currentPlanet = name; // jeÅ›li ksiÄ™Å¼yc â€“ nie zmieniamy currentPlanet

  updateCurrentPlanetHeader();
  refreshPlanetList();
  refreshPointsList();
  refreshGlobePoints();
  updateSelectedPlanetButtons();
  refreshPlanetSidebar();
  renderPlanetResourcesPanel();
  updatePlanetMiniPanel();

  // Ustaw od razu glob na wybranÄ… teksturÄ™
  globe.globeImageUrl(textureBase64);

  input.value = "";
  checkNewPlanetInput();
  alert(`Dodano nowy obiekt: ${isMoon ? "KsiÄ™Å¼yc" : "PlanetÄ™"} - ${name}`);
  updateNoPlanetsMessage();
}
  
// Lista planet
// Zwraca dane do renderowania â€“ tylko sortowanie i grupowanie
function getGroupedPlanets() {
  const createdAtMap = {};
  (planetData || []).forEach(pd => {
    if (pd && pd.name) createdAtMap[pd.name] = pd.createdAt || 0;
  });

  const structure = { "Nieznany": { "Nieznany": [] } };

  Object.keys(atlas).forEach(p => {
    const starSystem = (planetDetails[p]?.starSystem || "").trim() || "Nieznany";
    const planetSystem = (planetDetails[p]?.planetSystem || "").trim() || "Nieznany";

    if (!structure[starSystem]) structure[starSystem] = {};
    if (!structure[starSystem][planetSystem]) structure[starSystem][planetSystem] = [];
    structure[starSystem][planetSystem].push(p);
  });

  // Sortowanie wg daty utworzenia (zagnieÅ¼dÅ¼one)
  const INF = Number.MAX_SAFE_INTEGER;

  const sortedstarSystems = Object.keys(structure).sort((a, b) => {
    if (a === "Nieznany") return -1;
    if (b === "Nieznany") return 1;
    return a.localeCompare(b);
  });

  return sortedstarSystems.map(starSystem => {
    const planetSystemsObj = structure[starSystem];
    const sortedplanetSystems = Object.keys(planetSystemsObj).sort((a, b) => {
      if (a === "Nieznany") return -1;
      if (b === "Nieznany") return 1;
      return a.localeCompare(b);
    });
//Zwracamy gotowÄ… strukturÄ™ do wyrenderowania
    return {
      starSystem,
      planetSystems: sortedplanetSystems.map(sys => ({
        name: sys,
        planets: planetSystemsObj[sys].sort((p1, p2) =>
          (createdAtMap[p1] || INF) - (createdAtMap[p2] || INF)
        )
      }))
    };
  });
}

// Renderuje nagÅ‚Ã³wki i planety.
  
function refreshPlanetList() {
  const list = document.getElementById("planetList");
  if (!list) return;

  list.innerHTML = "";

  (planetData || []).forEach(planet => {
    const li = document.createElement("li");
    li.textContent = planet.name || "Nieznana planeta"; 
    li.style.cursor = "pointer";

    // podÅ›wietlenie wybranej planety (tak samo jak w sidebarze)
    if (planet.name === currentPlanet) {
      li.style.fontWeight = "bold";
      li.style.color = "#1976d2";
    }

    // obsÅ‚uga klikniÄ™cia w planetÄ™
    li.onclick = () => {
      currentPlanet = planet.name;

      // ustaw odpowiedniÄ… galaktykÄ™
      currentGalaxy = planetDetails[currentPlanet]?.galaxy || null;

      updateCurrentPlanetHeader();
      loadPlanetDetails();
      updateSelectedPlanetButtons();

      // odÅ›wieÅ¼ wszystko, Å¼eby synchronizowaÄ‡ podÅ›wietlenia
      refreshPlanetList();     // zaznaczenie w tej liÅ›cie
      refreshPlanetSidebar();  // zaznaczenie w sidebarze
      refreshGalaxySidebar();  // podÅ›wietlenie galaktyki
    };

    list.appendChild(li);
  });

  updateNoPlanetsMessage();
}


// Tworzy pojedynczy wiersz
function renderPlanetRow(p) {
  const container = document.createElement("div");
  container.style.display = "flex";
  container.style.alignItems = "center";
  container.style.margin = "0.2rem 0";

  const btn = document.createElement("button");
  btn.textContent = p;
  btn.style.flex = "1";
  btn.style.marginRight = "0.5rem";
  btn.style.background = "#e5e5e5";
  btn.style.color = "black";
  btn.style.border = "none";
  btn.style.padding = "0.3rem";
  btn.style.borderRadius = "4px";
  btn.style.cursor = "pointer";

// PodÅ›wietlanie wybranej planety
  if (p === currentPlanet) {
    btn.style.background = "#1976d2";  // niebieski
    btn.style.color = "white";
    btn.style.fontWeight = "bold";
  }
  
  btn.onclick = () => {
    if (isEditing) return; // blokada w trybie edycji
    currentPlanet = p;
    updateCurrentPlanetHeader();
    addPoles(p);
    refreshGlobePoints();
    globe.htmlElementsData(atlas[p].filter(pt => pt.type === "Pole"));
    refreshPointsList();
    loadPlanetDetails();
    selectPlanet(p);
    updateSelectedPlanetButtons();
    refreshPlanetList(); // <-- odÅ›wieÅ¼ listÄ™, Å¼eby przeÅ‚Ä…czyÄ‡ podÅ›wietlenie
  };

  container.appendChild(btn);
  return container;
}
  
 // Funkcja pomocnicza do aktualizacji planetData
function updatePlanetData(name, extra = {}) {
  const idx = planetData.findIndex(pd => pd.name === name);
  if (idx !== -1) {
    // aktualizacja istniejÄ…cego wpisu
    planetData[idx].extraInfo = {...planetData[idx].extraInfo, ...extra};
  } else {
    // jeÅ›li planeta nie istnieje, dodaj nowÄ…
    planetData.push({
      name: name,
      extraInfo: extra,
      createdAt: Date.now()
    });
  }
}
//Jest to uniwersalna funkcja updatePlanetData, ktÃ³ra utrzymuje spÃ³jnoÅ›Ä‡ tablicy planetData;
//MoÅ¼na Å‚atwo dodawaÄ‡ dodatkowe informacje do planet, bez zmieniania istniejÄ…cych struktur atlas i planetDetails;
//Nie zmienia siÄ™ istniejÄ…cy mechanizm dodawania, edycji ani usuwania planet â€“ wszystko jest kompatybilne.

// Funkcja aktualizujÄ…ca stan przyciskÃ³w w zaleÅ¼noÅ›ci od tego, czy planeta jest zaznaczona
function updateSelectedPlanetButtons() {
  const editBtn = document.getElementById("editSelectedPlanetBtn");
  const delBtn  = document.getElementById("deleteSelectedPlanetBtn");
  const enabled = !!currentPlanet;
  editBtn.disabled = !enabled;
  delBtn.disabled = !enabled;
}

// WywoÅ‚ujemy po kaÅ¼dej zmianie zaznaczenia planety
function selectPlanet(name) {
  const planet = planetData.find(p => p.name === name);
  if (!planet) return;
  currentPlanet = planet.name;
  updateCurrentPlanetHeader();
  globe.globeImageUrl(planet.texture || blackTextureURL);
  updateSelectedPlanetButtons();
	renderPlanetResourcesPanel();
	updatePlanetMiniPanel();
}

// Edycja zaznaczonej planety
function editSelectedPlanet() {
  if (!currentPlanet) {
    alert("Najpierw zaznacz planetÄ™.");
    return;
  }
  isEditing = true;
  setButtonsDisabled(true);
  
const box = document.getElementById("editPlanetBox");
  const input = document.getElementById("editPlanetName");

  // wstawiamy aktualnÄ… nazwÄ™ planety
  input.value = currentPlanet;

  // pokazujemy placeholder z edycjÄ…
  box.style.display = "flex";
  box.style.gap = "0.5rem"; // Å¼eby input i przyciski byÅ‚y Å‚adnie obok siebie
  input.focus();

  // wyÅ‚Ä…cz inne przyciski
  setButtonsDisabled(true);
  }
  
// Zatwierdzenie edycji
function acceptEditPlanet() {
  const newName = document.getElementById("editPlanetName").value.trim();

  if (!newName) {
    alert("Podaj nowÄ… nazwÄ™ planety.");
    return;
  }

  // JeÅ›li nazwa siÄ™ zmieniÅ‚a i juÅ¼ istnieje, blokujemy
  if (newName !== currentPlanet && atlas[newName]) {
    alert("Planeta o tej nazwie juÅ¼ istnieje!");
    return;
  }

  // Tylko jeÅ›li zmieniamy nazwÄ™ faktycznie
  if (newName !== currentPlanet) {
    atlas[newName] = atlas[currentPlanet];
    delete atlas[currentPlanet];

    planetDetails[newName] = planetDetails[currentPlanet] || {};
    delete planetDetails[currentPlanet];

    const idx = planetData.findIndex(p => p.name === currentPlanet);
    if (idx !== -1) planetData[idx].name = newName;

    currentPlanet = newName; // ustawiamy nowÄ… nazwÄ™ jako aktywnÄ…
  }

  refreshPlanetList();
  updateCurrentPlanetHeader();
  updateSelectedPlanetButtons();
  refreshPlanetSidebar();
  document.getElementById("editPlanetBox").style.display = "none";
  setButtonsDisabled(false);
  isEditing = false;
  setButtonsDisabled(false);
  checkNewPlanetInput();
	renderPlanetResourcesPanel();
	updatePlanetMiniPanel();
}

  function cancelEditPlanet() {
  // Ukryj box edycji
  document.getElementById("editPlanetBox").style.display = "none";

  // Odblokuj przyciski
  setButtonsDisabled(false);

  // ZakoÅ„cz tryb edycji
  isEditing = false;

  // SprawdÅº input nowej planety, Å¼eby przycisk "Dodaj nowÄ… planetÄ™" miaÅ‚ poprawny stan
  checkNewPlanetInput();
}
  
// UsuniÄ™cie zaznaczonej planety z potwierdzeniem
function deleteSelectedPlanet() {
  if (!currentPlanet) return;
  if (!confirm(`Czy na pewno usunÄ…Ä‡ planetÄ™ "${currentPlanet}" wraz ze wszystkimi punktami?`)) return;

  delete atlas[currentPlanet];
  delete planetDetails[currentPlanet];
  const idx = planetData.findIndex(p => p.name === currentPlanet);
  if (idx !== -1) planetData.splice(idx, 1);

  const planets = Object.keys(atlas);
  currentPlanet = planets.length ? planets[0] : null;

   if (currentPlanet) {
    selectPlanet(currentPlanet); // ustawia od razu poprawnÄ… teksturÄ™ globu
  } else {
    globe.globeImageUrl(blackTextureURL); // brak planet â†’ czarny glob
  }
  
  updateCurrentPlanetHeader();
  refreshPlanetList();
  refreshPointsList();
  refreshGlobePoints();
  updateSelectedPlanetButtons();
  refreshPlanetSidebar();
	renderPlanetResourcesPanel();
	updatePlanetMiniPanel();
}

// WywoÅ‚anie przy starcie, Å¼eby przyciski byÅ‚y poprawnie wyszarzone jeÅ›li brak planet
updateSelectedPlanetButtons();

// Funkcja pomocnicza (wÅ‚Ä…cz/wyÅ‚Ä…cz przycisk
function setButtonsDisabled(disabled) {
  document.querySelectorAll(".lock-while-edit").forEach(btn => {
    btn.disabled = disabled;
  });
}

// Galaktyki
function updateDefaultGalaxy(galaxy) {
  defaultGalaxy = galaxy || "Euclid";
  if (currentPlanet && planetDetails[currentPlanet]) {
    planetDetails[currentPlanet].galaxy = defaultGalaxy;
  }
}


// ustaw domyÅ›lnÄ… galaktykÄ™ w input na starcie.	
document.addEventListener("DOMContentLoaded", () => {
  const g = document.getElementById("galaxyInput");
  if (g) g.value = currentGalaxy;
  refreshGalaxySidebar();
	renderPlanetResourcesPanel();
});

// Renderowanie listy checkboxÃ³w pierwiastkÃ³w dla wybranej planety
function renderPlanetResourcesPanel() {
  const container = document.getElementById("planet-resources");
  if (!container) return;

  container.innerHTML = "";
 
  // Grid 6 kolumn (ikona, checkbox, nazwa Ã—2)
  const grid = document.createElement("div");
  grid.style.display = "grid";
  grid.style.gridTemplateColumns = "40px 20px auto 40px 20px auto";
  grid.style.gridGap = "4px";
  grid.style.alignItems = "center";
  container.appendChild(grid);
  
	// filtrujemy tylko ikony typu "resource"
  icons.filter(res => res.type === "resource")
    .forEach(res => {
    // Ikona pierwiastka
    const img = document.createElement("img");
    img.src = res.icon;
    img.alt = res.name;
    img.style.width = "40px";
    img.style.height = "40px";
    grid.appendChild(img);

    // Checkbox pierwiastka
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.disabled = !currentPlanet; // aktywny tylko jeÅ›li planeta jest wybrana

    // przechowujemy w dataset nazwÄ™ pierwiastka
    checkbox.dataset.resource = res.name;

    // ustawiamy stan checkboxa jeÅ›li planeta istnieje
    if (currentPlanet && planetDetails[currentPlanet]?.resources?.includes(res.name)) {
      checkbox.checked = true;
    }

    // obsÅ‚uga zmiany stanu
    checkbox.addEventListener("change", () => {
      if (!currentPlanet) return;

      if (!planetDetails[currentPlanet]) planetDetails[currentPlanet] = { resources: [] };
      const arr = planetDetails[currentPlanet].resources;

      if (checkbox.checked) {
        if (!arr.includes(res.name)) arr.push(res.name);
      } else {
        planetDetails[currentPlanet].resources = arr.filter(r => r !== res.name);
      }
	updatePlanetMiniPanel();
		// egzekwuj limit po kaÅ¼dej zmianie
        enforceResourceLimit(grid);
    });

    grid.appendChild(checkbox);

    // Nazwa pierwiastka
    const nameLabel = document.createElement("span");
    nameLabel.textContent = res.name;
    nameLabel.style.textAlign = "left";
    grid.appendChild(nameLabel);
  });
	// sprawdÅº limit przy pierwszym renderze
  enforceResourceLimit(grid);
}

// Funkcja do pilnowania limitu pierwiastkÃ³w
function enforceResourceLimit(scopeEl) {
  const checkboxes = scopeEl.querySelectorAll('input[type="checkbox"][data-resource]');
  const checked = Array.from(checkboxes).filter(cb => cb.checked);

  if (checked.length >= 12) {
    checkboxes.forEach(cb => {
      if (!cb.checked) cb.disabled = true;
    });
  } else {
    checkboxes.forEach(cb => {
      // tylko jeÅ›li planeta jest wybrana (Å¼eby zachowaÄ‡ logikÄ™)
      cb.disabled = !currentPlanet ? true : false;
    });
  }
}

// Mini panel z inofo o planecie
function updatePlanetMiniPanel() {
  const panel = document.getElementById("planetMiniPanel");
  if (!panel || !currentPlanet) return;

	// blokada: jeÅ›li panel jest ukryty, to nic nie rÃ³b
  if (panel.classList.contains("hidden")) return;
	
 // reset zawartoÅ›ci panelu
const contentEls = panel.querySelectorAll("div:not(:first-child)");
  contentEls.forEach(el => el.remove());

  const details = planetDetails[currentPlanet] || {};
 
  // USTAWIENIA GLOBALNE dla minipanelu
  const ICON_SIZE = 40;   // x2 (wczeÅ›niej byÅ‚o 20px)
  const FONT_SIZE = "18px"; // x2 (wczeÅ›niej ~9px)
 
	// === BIOM (ikona + tekst) ===
   const biomeRow = document.createElement("div");
  biomeRow.style.display = "flex";
  biomeRow.style.alignItems = "center";
  biomeRow.style.gap = "5px";

  const biomeIcon = icons.find(i => i.type === "UI" && i.name === "Planet");
  if (biomeIcon) {
    const img = document.createElement("img");
    img.src = biomeIcon.icon;
    img.style.width = ICON_SIZE + "px";
    img.style.height = ICON_SIZE + "px";
    biomeRow.appendChild(img);
  }

  const biomeText = document.createElement("span");
  biomeText.textContent = details.biome || "Nieznany biom";
  biomeRow.appendChild(biomeText);

  if (details.biomeAlias) {
    const aliasText = document.createElement("span");
    aliasText.textContent = `(${details.biomeAlias})`;
    aliasText.style.fontStyle = "italic";
    aliasText.style.color = "#555";
    biomeRow.appendChild(aliasText);
  }

  panel.appendChild(biomeRow);

  // straÅ¼nicy -> ikona + opis
  const sentinelsRow = document.createElement("div");
  sentinelsRow.style.display = "flex";
  sentinelsRow.style.alignItems = "center";
  sentinelsRow.style.gap = "2px";
	 
  const sentinelIcon = icons.find(i => i.type === "UI" && i.name === "Sentinel");
  if (sentinelIcon) {
    const img = document.createElement("img");
    img.src = sentinelIcon.icon;
    img.alt = "Sentinel";
    img.style.width = ICON_SIZE + "px";
    img.style.height = ICON_SIZE + "px";
    sentinelsRow.appendChild(img);
  }

  const sentinelsText = document.createElement("span");
  sentinelsText.textContent = details.sentinels || "Nieznani straÅ¼nicy";
  sentinelsRow.appendChild(sentinelsText);

  panel.appendChild(sentinelsRow);

  // kontener na pierwiastki
  const resourcesContainer = document.createElement("div");
  resourcesContainer.style.display = "flex";
  resourcesContainer.style.flexDirection = "column";
  resourcesContainer.style.gap = "1px";
	

  const resources = details.resources || [];
  const resourceIcons = icons.filter(i => i.type === "resource");
  resources.forEach(resName => {
    const resObj = icons.find(r => r.name === resName);
    if (!resObj) return;

    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.gap = "2px";

    const img = document.createElement("img");
    img.src = resObj.icon;
    img.alt = resObj.name;
    img.style.width = ICON_SIZE + "px";
    img.style.height = ICON_SIZE + "px";

    const label = document.createElement("span");
    label.textContent = resObj.name;

    row.appendChild(img);
    row.appendChild(label);
    resourcesContainer.appendChild(row);
  });

  panel.appendChild(resourcesContainer);
}

	// Funkcja do toggle mini panelu
function toggleMiniPanel() {
  const miniPanel = document.getElementById("planetMiniPanel");
  const btn = document.getElementById("toggleMiniPanelBtn");

  miniPanel.classList.toggle("hidden");

  if (miniPanel.classList.contains("hidden")) {
    btn.textContent = "â–²"; // panel ukryty â†’ strzaÅ‚ka w gÃ³rÄ™
  } else {
    btn.textContent = "â–¼"; // panel widoczny â†’ strzaÅ‚ka w dÃ³Å‚
    updatePlanetMiniPanel();
  }
}

// PodÅ‚Ä…cz przycisk
document.getElementById("toggleMiniPanelBtn").addEventListener("click", toggleMiniPanel);












////////////////////////////////////////////////////////////////////
//--------------- Punkty, lista, tworzenie, edycja ---------------//
//////////////////////////////////////////////////////////////////// 

// Ograniczenie zakresÃ³w imputÃ³w X I Y
const latInput = document.getElementById("lat");
const lngInput = document.getElementById("lng");

function clampLatLng() {
  let lat = parseFloat(latInput.value);
  let lng = parseFloat(lngInput.value);

  if (!isNaN(lat)) {
    if (lat < -90) lat = -90;
    if (lat > 90) lat = 90;
    latInput.value = lat;
  }

  if (!isNaN(lng)) {
    if (lng < -180) lng = -180;
    if (lng > 180) lng = 180;
    lngInput.value = lng;
  }
}

// NasÅ‚uchiwanie zmiany wartoÅ›ci
latInput.addEventListener("input", clampLatLng);
lngInput.addEventListener("input", clampLatLng);
  
// Lista punktow
function refreshPointsList() {
    const list = document.getElementById("pointsList");
    list.innerHTML = "";
    if (!currentPlanet || !atlas[currentPlanet]) return;

    // Wszystkie zwykÅ‚e punkty (bez biegunÃ³w i mojej lokalizacji)
    let points = atlas[currentPlanet].filter(p => p.type !== "Pole" && p.type !== "Moja");

    // Filtrujemy przez wspÃ³lnÄ… funkcjÄ™
    points = getFilteredPoints(points);

    // Sortowanie
    const sort = document.getElementById("sortPoints").value;
    if (sort === "nameAsc") points.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
    if (sort === "nameDesc") points.sort((a, b) => (b.name || "").localeCompare(a.name || ""));
    if (sort === "type") points.sort((a, b) => (a.type || "").localeCompare(b.type || ""));
    if (sort === "newest") points.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
    if (sort === "oldest") points.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

    // Tworzenie elementÃ³w <li>
    points.forEach(point => {
        const li = document.createElement("li");
        li.style.display = "flex";
        li.style.flexDirection = "column";
        li.style.alignItems = "flex-start";

        const info = document.createElement("span");
        info.innerHTML = `${point.name || "Bez nazwy"} (${point.type})<br>X:${point.lat}, Y:${point.lng}`;
        li.appendChild(info);

        const btnDiv = document.createElement("div");
        btnDiv.style.display = "flex";
        btnDiv.style.gap = "0.5rem";

        // PokaÅ¼ punkt
        const showBtn = document.createElement("button");
        showBtn.textContent = "PokaÅ¼";
        showBtn.className = "show";
        showBtn.style.background = "#388e3c";
        showBtn.style.color = "white";
      
        showBtn.onclick = () => {
          globe.pointOfView({ lat: point.lat, lng: point.lng, altitude: 1.5 }, 1000);

          // usuÅ„ highlight ze wszystkich punktÃ³w
          atlas[currentPlanet].forEach(p => delete p.__highlight);
          if (myLocationPoint) delete myLocationPoint.__highlight;

          // zatrzymaj ewentualny stary timeout
          if (highlightTimeout) {
            clearTimeout(highlightTimeout);
            highlightTimeout = null;
          }

          // ustaw highlight na klikniÄ™tym punkcie
          point.__highlight = true;
          refreshGlobePoints();

          // zdejmij highlight po 2s
          highlightTimeout = setTimeout(() => {
            delete point.__highlight;
            refreshGlobePoints();
            highlightTimeout = null;
          }, 2000);
        };

        btnDiv.appendChild(showBtn);

        // Checkbox dla extracted/visited
        if (point.type === "ZasÃ³b" || ["Inne", "Ruiny", "Struktura"].includes(point.type)) {
	    const checkbox = document.createElement("input");
	    checkbox.type = "checkbox";
	    // ustawienie poczÄ…tkowego stanu
	    checkbox.checked = point.type === "ZasÃ³b" ? !!point.extracted : !!point.visited;
	
	    // ustawienie poczÄ…tkowego tooltipa
	    checkbox.title = checkbox.checked ? "Wydobyty / Odwiedzony" : "Niewydobyty / Nieodwiedzony";
	
	    checkbox.onchange = () => {
	        if (point.type === "ZasÃ³b") point.extracted = checkbox.checked;
	        else point.visited = checkbox.checked;
	
	        // aktualizacja tooltipa po zmianie stanu
	        checkbox.title = checkbox.checked ? "Wydobyty / Odwiedzony" : "Niewydobyty / Nieodwiedzony";
	
	        refreshGlobePoints();
	        refreshPointsList();
	    };
	    btnDiv.appendChild(checkbox);
	}

        // Edycja punktu
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edytuj";
        editBtn.className = "edit";
        editBtn.onclick = () => editPoint(point.timestamp); // Musimy jednoznacznie wskazaÄ‡ ktÃ³ry punkt w atlasie edytujemy. NajproÅ›ciej przekazywaÄ‡ nie indeks, tylko unikalny identyfikator (timestamp, ktÃ³ry juÅ¼ dodajemy do kaÅ¼dego punktu).
        btnDiv.appendChild(editBtn);

        // Usuwanie punktu
        const delBtn = document.createElement("button");
        delBtn.textContent = "UsuÅ„";
        delBtn.className = "del";
        delBtn.onclick = () => {
            if (confirm(`Czy na pewno usunÄ…Ä‡ punkt "${point.name || "Bez nazwy"}" typu "${point.type}" o wspÃ³Å‚rzÄ™dnych X:${point.lat}, Y:${point.lng}?`)) {
                const idx = atlas[currentPlanet].findIndex(p => p.timestamp === point.timestamp);
                if (idx !== -1) {
                    atlas[currentPlanet].splice(idx, 1);
                    refreshPointsList();
                    refreshGlobePoints();
                }
            }
        };
        btnDiv.appendChild(delBtn);

        li.appendChild(btnDiv);
        list.appendChild(li);
    });
}

function getFilteredPoints(points) {
    const activeTypes = getActivePointTypes(); // checkboxy typÃ³w
    const activeExtras = Array.from(document.querySelectorAll(".extraFilter:checked"))
        .map(cb => cb.value); // checkboxy dodatkowe

    return points.filter(p => {
        // filtr po typach
        if (!activeTypes.includes(p.type)) return false;
        // filtr Wydobyty / Niewydobyty dla ZasÃ³b
        if (p.type === "ZasÃ³b") {
            const extracted = !!p.extracted;
            if (extracted && !activeExtras.includes("Wydobyty")) return false; // wydobyty, ale filtr Wydobyty nie zaznaczony â†’ ukryj
            if (!extracted && !activeExtras.includes("Niewydobyty")) return false; // niewydobyty, ale filtr Niewydobyty nie zaznaczony â†’ ukryj
        }
        // filtr Odwiedzony / Nieodwiedzony dla Ruiny/Struktura/Inne
        if (["Ruiny", "Struktura", "Inne"].includes(p.type)) {
            const visited = !!p.visited;
            if (visited && !activeExtras.includes("Odwiedzony")) return false; // odwiedzony, filtr Odwiedzony nie zaznaczony â†’ ukryj
            if (!visited && !activeExtras.includes("Nieodwiedzony")) return false; // nieodwiedzony, filtr Nieodwiedzony nie zaznaczony â†’ ukryj
        }

        return true;
    });
}

 // KlikniÄ™cie Edytuj nie usuwa punktu od razu.
//Punkt jest tymczasowo przygotowany do edycji (Å‚aduje siÄ™ do formularza).
//Dopiero klikniÄ™cie Nadpisz punkt faktycznie zmienia dane.
//Jak klikniesz â€žPunktyâ€ bez zapisania â†’ lista zostaje nietkniÄ™ta.
//Przycisk zmienia podpis w zaleÅ¼noÅ›ci od trybu.
  
function addPoint(){
  if (!currentPlanet) {
    alert("Najpierw wybierz planetÄ™ w zakÅ‚adce 'Planety'!");
    return;
  }

  const lat = parseFloat(document.getElementById("lat").value);
  const lng = parseFloat(document.getElementById("lng").value);
  const name = document.getElementById("name").value.trim();
  const type = document.getElementById("type").value;
  const notes = document.getElementById("notes").value.trim();

  // Sprawdzenie duplikatu
  const exists = atlas[currentPlanet].some(p =>
    p.lat === lat &&
    p.lng === lng &&
    p.name === name &&
    p.type === type &&
    p.notes === notes
  );
  if (exists) {
    alert(`Punkt typu "${type}" o wspÃ³Å‚rzÄ™dnych X:${lat}, Y:${lng} z takÄ… samÄ… notatkÄ… juÅ¼ istnieje!`);
    return;
  }
  
  if (isNaN(lat) || isNaN(lng)) {
    alert("Podaj wspÃ³Å‚rzÄ™dne X i Y!");
    return;
  }

  const point = {planet: currentPlanet, lat, lng, name, type, notes, timestamp: Date.now()};
  // DomyÅ›lnie wszystkie punkty sÄ… odwiedzone i wydobyte
    if(type === "ZasÃ³b") point.extracted = true; 
    if(["Inne", "Ruiny", "Struktura"].includes(type)) point.visited = true; 
    if (editIndex !== null && atlas[currentPlanet][editIndex]) {
  atlas[currentPlanet][editIndex] = point;
  // po nadpisaniu resetujemy stan edycji i chowamy Anuluj
  cancelEditPoint();
  openTab("punkty");
} else {
  atlas[currentPlanet].push(point);
}
  alert(`Dodano nowy punkt: ${name}`);
  refreshPlanetList();
  refreshGlobePoints();
  refreshPointsList();
}

function editPoint(timestamp){   
  if(!currentPlanet || !atlas[currentPlanet]) return;
   
  isEditing = true;
  setButtonsDisabled(true);
  
  const index = atlas[currentPlanet].findIndex(p => p.timestamp === timestamp);
  if(index === -1) return;

  const p = atlas[currentPlanet][index];
  document.getElementById("lat").value = p.lat;
  document.getElementById("lng").value = p.lng;
  document.getElementById("name").value = p.name;
  document.getElementById("type").value = p.type;
  document.getElementById("notes").value = p.notes;

  editIndex = index; // zapamiÄ™taj indeks prawidÅ‚owego punktu w atlasie
  const addBtn = document.querySelector("button[onclick='addPoint()']");
  addBtn.textContent = "Nadpisz punkt";

  showCancelEditButton();

  // przeÅ‚Ä…czenie na zakÅ‚adkÄ™ START
  openTab('start');
}

function showCancelEditButton() {
  let cancelBtn = document.getElementById("cancelEditBtn");
  if (!cancelBtn) {
    const addBtn = document.querySelector("button[onclick='addPoint()']");
    
    // kontener na przyciski, jeÅ›li jeszcze nie istnieje
    let btnWrapper = document.getElementById("editBtnWrapper");
    if (!btnWrapper) {
      btnWrapper = document.createElement("div");
      btnWrapper.id = "editBtnWrapper";
      btnWrapper.style.display = "flex";
      btnWrapper.style.flexDirection = "column";
      btnWrapper.style.gap = "0.5rem";
      addBtn.parentNode.insertBefore(btnWrapper, addBtn);
      btnWrapper.appendChild(addBtn);
    }

    cancelBtn = document.createElement("button");
    cancelBtn.id = "cancelEditBtn";
    cancelBtn.textContent = "Anuluj";
    cancelBtn.style.backgroundColor = "#d32f2f"; // czerwony
    cancelBtn.style.color = "white";
    cancelBtn.style.border = "none";
    cancelBtn.style.padding = "0.5rem";
    cancelBtn.style.borderRadius = "6px";
    cancelBtn.style.cursor = "pointer";
    cancelBtn.onmouseover = () => cancelBtn.style.backgroundColor = "#b71c1c";
    cancelBtn.onmouseout = () => cancelBtn.style.backgroundColor = "#d32f2f";

    cancelBtn.onclick = cancelEditPoint;

    btnWrapper.appendChild(cancelBtn);
  }
}

function cancelEditPoint() {
  editIndex = null;
  const addBtn = document.querySelector("button[onclick='addPoint()']");
  addBtn.textContent = "Dodaj punkt";

  const cancelBtn = document.getElementById("cancelEditBtn");
  if(cancelBtn) cancelBtn.remove();

  document.getElementById("lat").value = "";
  document.getElementById("lng").value = "";
  document.getElementById("name").value = "";
  document.getElementById("type").value = "ZasÃ³b";
  document.getElementById("notes").value = "";

  isEditing = false;
  setButtonsDisabled(false);
  openTab("punkty");
}

// Utomatyczne tworzenie biegunÃ³w
function addPoles(planet){
  if(!atlas[planet]) atlas[planet] = [];
  if(!atlas[planet].some(p => p.type==="Pole")){
    atlas[planet].push({lat:90,lng:0,name:"Biegun PÃ³Å‚nocny",type:"Pole"});
    atlas[planet].push({lat:-90,lng:0,name:"Biegun PoÅ‚udniowy",type:"Pole"});
  }
}

// Funkcja tworzÄ…ca teksturÄ™ z gwiazdkÄ…
function createStarTexture() {
    const canvas = document.createElement('canvas');
    canvas.width = 64;
    canvas.height = 64;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.font = '48px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = 'yellow'; // kolor gwiazdki
    ctx.fillText('â­', canvas.width/2, canvas.height/2);
    const texture = new THREE.CanvasTexture(canvas);
    return texture;
}

 function updateMyLocation() {
  const lat = parseFloat(document.getElementById("myLat").value);
  const lng = parseFloat(document.getElementById("myLng").value);

  if (isNaN(lat) || isNaN(lng)) {
    myLocationPoint = null;
  } else {
    myLocationPoint = { 
      lat, 
      lng, 
      altitude: 0.02, 
      type: "Moja", 
     };
  }

  refreshGlobePoints(); // rysujemy razem z resztÄ…
}

document.getElementById("myLat").addEventListener("input", updateMyLocation);
document.getElementById("myLng").addEventListener("input", updateMyLocation);

// Ograniczenie zakresu dla mojej lokalizacji
const myLatInput = document.getElementById("myLat");
const myLngInput = document.getElementById("myLng");

function clampMyLatLng() {
  let lat = parseFloat(myLatInput.value);
  let lng = parseFloat(myLngInput.value);

  if (!isNaN(lat)) {
    if (lat < -90) lat = -90;
    if (lat > 90) lat = 90;
    myLatInput.value = lat;
  }

  if (!isNaN(lng)) {
    if (lng < -180) lng = -180;
    if (lng > 180) lng = 180;
    myLngInput.value = lng;
  }
}

myLatInput.addEventListener("input", clampMyLatLng);
myLngInput.addEventListener("input", clampMyLatLng);
 
// odÅ›wieÅ¼amy glob z uwzglÄ™dnieniem mnoÅ¼nika wysokoÅ›ci
 function refreshGlobePoints() {
    if (!currentPlanet) return;

    let allPoints = atlas[currentPlanet] ? [...atlas[currentPlanet]] : [];
    if (myLocationPoint) allPoints.push(myLocationPoint);

    const filteredPoints = getFilteredPoints(allPoints);

    globe.pointsData(filteredPoints)
        .pointAltitude(d => (d.altitude || 0.02) * pointsDistanceMultiplier);

    globe.htmlElementsData(filteredPoints.filter(d => d.type === "Pole" || d.type === "Moja"));
}

// System filtrowania punktÃ³w
function getActivePointTypes() {
  return Array.from(document.querySelectorAll(".pointFilter:checked"))
              .map(cb => cb.value);
}
  
////////////////////////////////////////////////////////////////////
//------------------- Tekstury i kolory planet -------------------//
////////////////////////////////////////////////////////////////////  

function addTextureUrl() {
  const texture = document.getElementById('planetTextureUrl').value.trim();
  if (!texture) {
    alert("Podaj URL tekstury!");
    return;
  }

  // sprawdzenie podstawowe, URL musi zaczynaÄ‡ siÄ™ od http(s):// lub textures/
  if (!/^https?:\/\/|^textures\//.test(texture)) {
    alert("NieprawidÅ‚owy URL lub lokalna Å›cieÅ¼ka!");
    return;
  }

  // sprawdzamy, czy plik istnieje
  const img = new Image();
  img.src = texture;
  img.onload = () => {
    // obraz istnieje â†’ zapisujemy w planetData
    const planet = planetData.find(p => p.name === currentPlanet);
    if (!planet) {
      alert("Najpierw wybierz planetÄ™!");
      return;
    }

    // zapisz nowÄ… teksturÄ™ w danych planety
    planet.texture = texture;

    // ustaw teksturÄ™ na globie
    globe.globeImageUrl(texture);

    // dopisanie do listy textures, jeÅ›li nowa
    if (!textures.includes(texture)) {
      textures.push(texture);
      // ustaw stronÄ™ galerii tak, by nowa miniatura byÅ‚a widoczna
      currentTexturePage = Math.floor((textures.length - 1) / TEXTURES_PER_PAGE);
      renderTexturePage();
    }

    alert(`Dodano teksturÄ™ do planety ${currentPlanet}`);
  };
  img.onerror = () => {
    alert("Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ obrazu. SprawdÅº URL lub lokalnÄ… Å›cieÅ¼kÄ™.");
  };
}

  // PrzeÅ‚Ä…cznik aktywnej planety
  function selectPlanet(name) {
  // Szuka w tablicy planet obiektu, ktÃ³ry ma taki sam 'name'
    const planet = planetData.find(p => p.name === name);
  // JeÅ›li nic nie znalazÅ‚a â†’ koÅ„czy dziaÅ‚anie
    if (!planet) return; 

  // Ustawia globalnÄ… zmiennÄ… currentPlanet na tÄ™ planetÄ™
    currentPlanet = planet.name;
       
  // UÅ¼ywamy tekstury planety jeÅ›li istnieje, w przeciwnym razie czarna
  const textureToUse = planet.texture ? planet.texture : blackTextureURL;
globe.globeImageUrl(textureToUse);
}

  // Funkcja do zmiany koloru planety
function changePlanetColor() {
  if (!currentPlanet) {
    alert("Najpierw wybierz planetÄ™!");
    return;
  }

  const colorHex = document.getElementById("PlanetColor").value || "#000000";
  const textureBase64 = hexToBase64Texture(colorHex);

  // znajdÅº wpis w planetData
  const idx = planetData.findIndex(p => p.name === currentPlanet);
  if (idx !== -1) {
    planetData[idx].texture = textureBase64;
    globe.globeImageUrl(textureBase64);
    }
}

   // Funkcja sprawdzajÄ…ca, czy w polu tekstury coÅ› wpisano 
function checkTextureInput() {
  const input = document.getElementById("planetTextureUrl");
  const button = input.nextElementSibling; // przycisk obok pola
  button.disabled = input.value.trim() === "";
}

//Galeria miniatur 
const textures = []; // lista wszystkich tekstur
let currentTexturePage = 0;
const TEXTURES_PER_PAGE = 12; // 2 wiersze x 6 kolumn

// renderuje aktualnÄ… stronÄ™ galerii
function renderTexturePage() {
  const gallery = document.getElementById('textureGallery');
  gallery.innerHTML = '';

  const start = currentTexturePage * TEXTURES_PER_PAGE;
  const end = start + TEXTURES_PER_PAGE;
  const pageTextures = textures.slice(start, end);

  pageTextures.forEach(tex => {
    const img = document.createElement('img');
    img.src = tex;
    img.className = 'texture-thumb';
    img.title = tex;
    img.onclick = () => {
      document.getElementById('planetTextureUrl').value = tex;
      addTextureUrl();
    };
    gallery.appendChild(img);
  });

  // wÅ‚Ä…cz/wyÅ‚Ä…cz przyciski
  document.getElementById('prevTexturePage').disabled = currentTexturePage === 0;
  document.getElementById('nextTexturePage').disabled = end >= textures.length;
}

// zmiana strony galerii
function changeTexturePage(delta) {
  currentTexturePage += delta;
  renderTexturePage();
}


////////////////////////////////////////////////////////////////////
//---------------- Eksport / Import Atlasu ---------------//
////////////////////////////////////////////////////////////////////  

function exportAtlas(){
  const blob = new Blob([JSON.stringify({
    atlas,
    planetDetails,
    planetData,
    textures // dodajemy listÄ™ galerii do JSON
  }, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "atlas.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importAtlas(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try{
      const data = JSON.parse(e.target.result);
      if(data.atlas) atlas = data.atlas;
      if(data.planetDetails) planetDetails = data.planetDetails;
      if(data.planetData) planetData = data.planetData;
      if(data.textures) {
        textures.length = 0;        // wyczyÅ›Ä‡ obecnÄ… listÄ™
        textures.push(...data.textures); // wczytaj importowane
        currentTexturePage = 0;     // ustaw poczÄ…tkowÄ… stronÄ™
        renderTexturePage();        // odtwÃ³rz galeriÄ™
      }
      const planets = Object.keys(atlas);
      currentPlanet = planets[0] || null;
      if (currentPlanet) selectPlanet(currentPlanet);
      else globe.globeImageUrl(blackTextureURL);

      updateCurrentPlanetHeader();
      refreshPlanetList();
      refreshPointsList();
      refreshGlobePoints();
      updateNoPlanetsMessage();
      refreshPlanetSidebar();
	  refreshGalaxySidebar();

      alert("Import zakoÅ„czony!");
    } catch(err){ 
      console.error(err);
      alert("BÅ‚Ä…d importu JSON"); 
    }
  };
  reader.readAsText(file);
}

////////////////////////////////////////////////////////////////////
//---------------- Skalowanie Globu i PunktÃ³w ----------------//
////////////////////////////////////////////////////////////////////  
  
// Skalowanie punktÃ³w
function updatePointScale(){
  pointScale = parseFloat(document.getElementById("pointScale").value);
  document.getElementById("pointScaleValue").textContent = pointScale;
  refreshGlobePoints();
}
function resetPointScale(){
  document.getElementById("pointScale").value = 0.4;
  updatePointScale();
}

// Sklaowanie wysokoÅ›ci sÅ‚upka
function updatePointsDistanceMultiplier() {
  pointsDistanceMultiplier = parseFloat(document.getElementById("pointsDistanceMultiplier").value);
  document.getElementById("pointsDistanceMultiplierValue").textContent = pointsDistanceMultiplier;
  refreshGlobePoints();
}
function resetPointsDistanceMultiplier(){
  document.getElementById("pointsDistanceMultiplier").value = 1;
  updatePointsDistanceMultiplier();
}

//Skalowanie wielkoÅ›ci planety
function updateGlobeZoomMultiplier() {
  globeZoomMultiplier = parseFloat(document.getElementById("globeZoomMultiplier").value);
  document.getElementById("globeZoomMultiplierValue").textContent = globeZoomMultiplier;
  globe.scene().scale.set(globeZoomMultiplier, globeZoomMultiplier, globeZoomMultiplier);
}
function resetGlobeZoomMultiplier(){
  document.getElementById("globeZoomMultiplier").value = 1;
  updateGlobeZoomMultiplier();
}

function toggleAutoRotate() {
  const controls = globe.controls();
  if (document.getElementById("autoRotateCheckbox").checked) {
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.7; // prÄ™dkoÅ›Ä‡ obrotu, moÅ¼esz zmieniaÄ‡
  } else {
    controls.autoRotate = false;
  }
}
  
////////////////////////////////////////////////////////////////////
//---------------------- Inicjalizacja globu ---------------------//
//////////////////////////////////////////////////////////////////// 
  
  // Tworzymy czarnÄ… teksturÄ™ globalnie, ktÃ³ra zastÄ…pi globeImageUrl(null). 
  // Podczas tworzenia planet, jeÅ›li od razu nie przypisywaliÅ›my tekstury i pozstawialiÅ›my pusty glob
  // to generowaÅ‚o to bÅ‚Ä™dy podczas przeÅ‚Ä…czania siÄ™ miÄ™dzy planetami na liÅ›cie planet - nie wyÅ›wietlaÅ‚o poprawnie globu. 
  
  const blackTextureURL = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=";

  
  // Inicjalizacja globu â€” uÅ¼ywamy https aby tÅ‚o zawsze siÄ™ zaÅ‚adowaÅ‚o
const globe = Globe()(document.getElementById("globeViz"))
  .globeImageUrl(null) // brak domyÅ›lnej mapy (pusta/ciemna kula)
  .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png') // ðŸŒŒ gwiazdy w tle

  .pointLat("lat")
  .pointLng("lng")
  .pointLabel(d => {
    // zabezpieczenie: gdy nie ma currentPlanet, zwracamy opis punktu pojedynczo
    if (!currentPlanet || !atlas[currentPlanet]) {
    let label = `${d.name || ""} (${d.type})<br>X:${d.lat}, Y:${d.lng}`;
    if (d.type === "ZasÃ³b") label += d.extracted ? " [Wydobyty]" : " [Niewydobyty]";
    if (["Ruiny","Struktura","Inne"].includes(d.type)) label += d.visited ? " [Odwiedzony]" : " [Nieodwiedzony]";
    return label;
  }

    // grupowanie punktÃ³w w tym samym miejscu dla aktualnej planety
     const sameLocation = atlas[currentPlanet].filter(p => p.lat === d.lat && p.lng === d.lng);
      if (sameLocation.length > 1) {
        return sameLocation.map(p => {
          let label = `${p.name || "Bez nazwy"} (${p.type})`;
          if (p.type === "ZasÃ³b") label += p.extracted ? " [Wydobyty]" : " [Niewydobyty]";
          if (["Ruiny","Struktura","Inne"].includes(p.type)) label += p.visited ? " [Odwiedzony]" : " [Nieodwiedzony]";
          return label;
        }).join("<br>");
      }

      let label = `${d.name || ""} (${d.type})<br>X:${d.lat}, Y:${d.lng}`;
      if (d.type === "ZasÃ³b") label += d.extracted ? " [Wydobyty]" : " [Niewydobyty]";
      if (["Ruiny","Struktura","Inne"].includes(d.type)) label += d.visited ? " [Odwiedzony]" : " [Nieodwiedzony]";
      return label;
    })
  .pointColor(d => {
  if (d && d.__highlight) return "orange";   // zawsze najpierw sprawdÅº highlight
                                             // wtedy nie trzeba nadpisywaÄ‡ pointColor w show i highlight bÄ™dzie dziaÅ‚aÄ‡ zawsze, przy kaÅ¼dym odÅ›wieÅ¼eniu.
  switch (d.type) {
    case "ZasÃ³b":     return d.extracted ? "gray" : "gold";
    case "Baza":      return "blue";
    case "Ruiny":     return d.visited ? "lime" : "orange";
    case "Struktura": return d.visited ? "cyan" : "magenta";
    case "Inne":      return d.visited ? "purple" : "brown";
    case "Pole":      return "red";
    default:          return "red";
  }
})
  .pointRadius(() => pointScale)
  .htmlElementsData([])
  .htmlElement(d=>{
    if(d.type==="Pole"){
      const el=document.createElement("div");
      el.style.color="white";
      el.style.fontSize="20px";
      el.style.fontWeight="bold";
      el.style.textShadow="0 0 4px black";
      el.textContent=d.name==="Biegun PÃ³Å‚nocny"?"N":"S";
      return el;
    }
    if (d.type === "Moja") {
      const el = document.createElement("div");
      el.style.color = "yellow";
      el.style.fontSize = "22px";
      el.style.fontWeight = "bold";
      el.style.textShadow = "0 0 6px black";
      el.textContent = "â­";
      return el;
    }
  });

//Panel z ntotakami punktu	
const pointNotesPanel = document.getElementById("pointNotesPanel");
let autoScrollInterval = null;
let autoScrollTimeout = null;

globe.onPointHover(point => {
  clearInterval(autoScrollInterval);
  clearTimeout(autoScrollTimeout);
  pointNotesPanel.scrollTop = 0; // zawsze start od gÃ³ry

  if (point && point.notes) {
    pointNotesPanel.textContent = point.notes;
    pointNotesPanel.style.display = "block";

    // po 15 sekundach zaczynamy przewijanie w dÃ³Å‚
    autoScrollTimeout = setTimeout(() => {
      autoScrollInterval = setInterval(() => {
        if (
          pointNotesPanel.scrollTop + pointNotesPanel.clientHeight <
          pointNotesPanel.scrollHeight
        ) {
          pointNotesPanel.scrollTop += 1; // przewijamy 1px
        } else {
          clearInterval(autoScrollInterval); // zatrzymaj na koÅ„cu
        }
      }, 100); // prÄ™dkoÅ›Ä‡ scrolla (ms)
    }, 12000); // start po 12 sekundach

  } else {
    pointNotesPanel.style.display = "none";
  }
});
	
// ustawienie punktÃ³w dla aktualnej planety
if (currentPlanet && atlas[currentPlanet]) {
  globe.pointsData(atlas[currentPlanet]);
  globe.htmlElementsData(atlas[currentPlanet].filter(p => p.type === "Pole"));
}
//NasÅ‚uchiwacze dla filtrÃ³w typÃ³w i dodatkowych
  // Checkboxy typÃ³w punktÃ³w
document.querySelectorAll(".pointFilter").forEach(cb => {
    cb.addEventListener("change", () => {
        refreshPointsList();
        refreshGlobePoints();
    });
});

// Checkboxy dodatkowe (Wydobyty/Niewydobyty/Odwiedzony/Nieodwiedzony)
document.querySelectorAll(".extraFilter").forEach(cb => {
    cb.addEventListener("change", () => {
        refreshPointsList();
        refreshGlobePoints();
    });
});

	//NasÅ‚uchuje stan Checkboxa ksiÄ™Å¼yca i zmienia nazwÄ™ przycisku "StwÃ³rz"
	document.addEventListener("DOMContentLoaded", () => {
	  const isMoonCheckbox = document.getElementById("isMoonCheckbox");
	  const addPlanetBtn = document.getElementById("addPlanetBtn"); // TwÃ³j przycisk "StwÃ³rz nowÄ… planetÄ™"

	  if (isMoonCheckbox && addPlanetBtn) {
		// Na start ustaw wÅ‚aÅ›ciwy tekst
		addPlanetBtn.textContent = isMoonCheckbox.checked ? "StwÃ³rz nowy ksiÄ™Å¼yc" : "StwÃ³rz nowÄ… planetÄ™";

		// NasÅ‚uchiwanie na zmianÄ™ checkboxa
		isMoonCheckbox.addEventListener("change", () => {
		  addPlanetBtn.textContent = isMoonCheckbox.checked ? "StwÃ³rz nowy ksiÄ™Å¼yc" : "StwÃ³rz nowÄ… planetÄ™";
		});
	  }
	});

  //NasÅ‚uchiwacz dla sortowania
  const sortSelect = document.getElementById("sortPoints");
if(sortSelect) {
    sortSelect.addEventListener("change", () => {
        refreshPointsList();
    });
}
  
 // inicjalizacja przyciskÃ³w przewijania minigalerii na starcie
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById('prevTexturePage').disabled = true;
  document.getElementById('nextTexturePage').disabled = true;
  }); 
    
globe.showGraticules(true).graticuleLineWidth(0.5);

// start
window.onload = () => {
  openTab("start"); // aktywuj pierwszÄ… zakÅ‚adkÄ™
  refreshPlanetList();
  refreshPointsList();
  updateNoPlanetsMessage();
  checkNewPlanetInput();
  updateCurrentPlanetHeader();
}
  
</script>
</body>
</html>
