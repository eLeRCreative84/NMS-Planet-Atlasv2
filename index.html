<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<title>Mapa 3D NMS – konwersja portal/galactic</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<style>
  body { margin:0; overflow:hidden; background:black; font-family:sans-serif; }
  #renderCanvas { width:100vw; height:100vh; touch-action:none; display:block; }
  #hud {
    position: absolute; top: 10px; left: 10px; padding:10px;
    background: rgba(0,0,0,0.6); color:white; border-radius:5px;
    font-size:14px;
  }
  #hud input { width:130px; margin:2px; }
  #hud button { margin:3px; }
</style>
</head>
<body>

<canvas id="renderCanvas"></canvas>

<div id="hud">
  <div>
    X: <input type="number" id="xInput" value="0">
    Y: <input type="number" id="yInput" value="0">
    Z: <input type="number" id="zInput" value="0" readonly>
  </div>

  <div>
    Galactic: <input type="text" id="coordInput" placeholder="AAAA:BBBB:CCCC:DDDD">
  </div>

  <div>
    Portal: <input type="text" id="portalInput" placeholder="003DFD6ACF8C">
  </div>

  <div>
    <button id="addPoint">Dodaj</button>
    <button id="zoomToPoint">Zoom</button>
    <button id="editPoint">Edytuj</button>
    <button id="deletePoint">Usuń</button>
  </div>
</div>
  
<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);
const scene = new BABYLON.Scene(engine);

// === Kamera i światło ===
const camera = new BABYLON.ArcRotateCamera("camera", Math.PI/4, Math.PI/4, 150, new BABYLON.Vector3(0,0,0), scene);
camera.attachControl(canvas, true);
const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);

// === Skybox ===
const skybox = BABYLON.MeshBuilder.CreateBox("skyBox", {size:10000}, scene);
const skyboxMaterial = new BABYLON.StandardMaterial("skyBoxMat", scene);
skyboxMaterial.backFaceCulling = false;
skyboxMaterial.disableLighting = true;
skyboxMaterial.diffuseColor = new BABYLON.Color3(0,0,0);
skyboxMaterial.specularColor = new BABYLON.Color3(0,0,0);
skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture(
  "https://raw.githubusercontent.com/eLeRCreative84/NMS-Planet-Atlasv2/main/textures/skybox/sky1",
  scene
);
skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
skybox.material = skyboxMaterial;

// === Punkty i połączenia ===
let points = [];
let lines = [];
let selectedPoint = null;

const pointMaterial = new BABYLON.StandardMaterial("pointMat", scene);
pointMaterial.emissiveColor = new BABYLON.Color3(0,1,0);
const selectedMaterial = new BABYLON.StandardMaterial("selectedMat", scene);
selectedMaterial.emissiveColor = new BABYLON.Color3(1,0,0);

// === Pomocnicze ===
function focusCameraOn(point, distance = 60) {
  const target = point.position.clone();
  const direction = camera.position.subtract(camera.target).normalize().scale(distance);
  const newPosition = target.add(direction);
  BABYLON.Animation.CreateAndStartAnimation("camMove", camera, "position", 60, 60,
    camera.position.clone(), newPosition, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
  BABYLON.Animation.CreateAndStartAnimation("camTarget", camera, "target", 60, 60,
    camera.target.clone(), target, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
}

// Generowanie Z deterministycznie z ID (DDDD)
function generateZ(id) {
  let sum = 0;
  for (let i = 0; i < id.length; i++) sum += id.charCodeAt(i);
  return (sum % 201) - 100; // zakres -100..100
}

// === Funkcje konwersji ===
function galacticToXYZ(g) {
  const parts = g.split(':');
  if (parts.length !== 4) throw new Error("Format AAAA:BBBB:CCCC:DDDD");
  const [region, bx, by, id] = parts;
  const x = parseInt(bx, 16);
  const y = parseInt(by, 16);
  const z = generateZ(id);
  return { x, y, z, region, id };
}

function xyzToGalactic(x,y,z,id="0000") {
  return `FFFF:${x.toString(16).padStart(4,'0')}:${y.toString(16).padStart(4,'0')}:${id}`;
}

function xyzToPortal(x,y,z) {
  return (x & 0xFFF).toString(16).padStart(4,'0') +
         (y & 0xFFF).toString(16).padStart(4,'0') +
         (z & 0xFFF).toString(16).padStart(4,'0');
}

function portalToXYZ(p) {
  if (p.length !== 12) throw new Error("Portal ma 12 znaków hex!");
  return {
    x: parseInt(p.slice(0,4),16),
    y: parseInt(p.slice(4,8),16),
    z: parseInt(p.slice(8,12),16)
  };
}

// === Aktualizacja HUD po wpisaniu koordynatów ===
const coordInput = document.getElementById("coordInput");
const portalInput = document.getElementById("portalInput");
const xInput = document.getElementById("xInput");
const yInput = document.getElementById("yInput");
const zInput = document.getElementById("zInput");

// zmiana w polu Galactic → automatycznie przelicza na Portal
coordInput.addEventListener("change", ()=>{
  try {
    const res = galacticToXYZ(coordInput.value.trim());
    const portal = xyzToPortal(res.x,res.y,res.z);
    portalInput.value = portal;
    xInput.value = res.x;
    yInput.value = res.y;
    zInput.value = res.z;
  } catch(e){}
});

// zmiana w polu Portal → automatycznie przelicza na Galactic
portalInput.addEventListener("change", ()=>{
  try {
    const res = portalToXYZ(portalInput.value.trim());
    const gal = xyzToGalactic(res.x,res.y,res.z,"AUTO");
    coordInput.value = gal;
    xInput.value = res.x;
    yInput.value = res.y;
    zInput.value = res.z;
  } catch(e){}
});

// === Dodawanie punktu ===
function addPoint(x, y, z, meta = {}) {
  const sphere = BABYLON.MeshBuilder.CreateSphere(`p${points.length}`, { diameter: 2 }, scene);
  sphere.position.set(x, y, z);
  sphere.material = pointMaterial.clone();
  sphere.metadata = meta;

  if (selectedPoint && selectedPoint !== sphere) {
    const path = [selectedPoint.position, sphere.position];
    const line = BABYLON.MeshBuilder.CreateLines("line", { points: path }, scene);
    line.color = new BABYLON.Color3(1, 1, 0);
    line.metadata = { a: selectedPoint, b: sphere };
    lines.push(line);
  }

  points.push(sphere);

  sphere.actionManager = new BABYLON.ActionManager(scene);
  sphere.actionManager.registerAction(new BABYLON.ExecuteCodeAction(
    BABYLON.ActionManager.OnPickTrigger,
    function() {
      if (selectedPoint) selectedPoint.material = pointMaterial.clone();
      selectedPoint = sphere;
      selectedPoint.material = selectedMaterial;

      const meta = selectedPoint.metadata || {};
      xInput.value = selectedPoint.position.x.toFixed(2);
      yInput.value = selectedPoint.position.y.toFixed(2);
      zInput.value = selectedPoint.position.z.toFixed(2);
      coordInput.value = meta.galactic || "";
      portalInput.value = meta.portal || "";
    }
  ));

  if (selectedPoint) selectedPoint.material = pointMaterial.clone();
  selectedPoint = sphere;
  selectedPoint.material = selectedMaterial;

  xInput.value = x.toFixed(2);
  yInput.value = y.toFixed(2);
  zInput.value = z.toFixed(2);
  coordInput.value = meta.galactic || "";
  portalInput.value = meta.portal || "";

  focusCameraOn(selectedPoint);
}

// === Przyciski HUD ===
document.getElementById('addPoint').addEventListener('click',()=>{
  const coordVal = coordInput.value.trim();
  const portalVal = portalInput.value.trim();

  let x, y, z, gal, portal, id;

  if (coordVal.includes(':')) {
    const res = galacticToXYZ(coordVal);
    x = res.x; y = res.y; z = res.z; id = res.id;
    gal = coordVal;
    portal = xyzToPortal(x,y,z);
  } else if (portalVal.length === 12) {
    const res = portalToXYZ(portalVal);
    x = res.x; y = res.y; z = res.z;
    id = "PORT";
    gal = xyzToGalactic(x,y,z,id);
    portal = portalVal;
  } else {
    x = parseFloat(xInput.value);
    y = parseFloat(yInput.value);
    id = "USER";
    z = generateZ(id);
    gal = xyzToGalactic(x,y,z,id);
    portal = xyzToPortal(x,y,z);
  }

  addPoint(x,y,z,{galactic:gal,portal,id});
});

document.getElementById('zoomToPoint').addEventListener('click',()=>{
  if (selectedPoint) focusCameraOn(selectedPoint);
});

document.getElementById('editPoint').addEventListener('click',()=>{
  if (!selectedPoint) return alert("Nie zaznaczono punktu!");
  const x=parseFloat(xInput.value), y=parseFloat(yInput.value), z=parseFloat(zInput.value);
  selectedPoint.position.set(x,y,z);
  const gal = xyzToGalactic(x,y,z, selectedPoint.metadata.id);
  const portal = xyzToPortal(x,y,z);
  selectedPoint.metadata = {galactic:gal,portal,id:selectedPoint.metadata.id};
  coordInput.value = gal;
  portalInput.value = portal;
  lines.forEach(line=>{
    if(line.metadata.a===selectedPoint||line.metadata.b===selectedPoint)
      BABYLON.MeshBuilder.CreateLines(null,{points:[line.metadata.a.position,line.metadata.b.position],instance:line});
  });
});

document.getElementById('deletePoint').addEventListener('click',()=>{
  if(!selectedPoint) return alert("Nie zaznaczono punktu!");
  lines = lines.filter(line=>{
    if(line.metadata.a===selectedPoint||line.metadata.b===selectedPoint){ line.dispose(); return false;}
    return true;
  });
  points = points.filter(p=>p!==selectedPoint);
  selectedPoint.dispose();
  selectedPoint=null;
});

engine.runRenderLoop(()=>scene.render());
window.addEventListener("resize",()=>engine.resize());
</script>

</body>
</html>
